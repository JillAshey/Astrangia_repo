---
title: "miranda"
author: "Jill Ashey"
date: "2025-05-13"
output: html_document
---

Looking at miranda output for 3'UTR and full mRNA binding. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

Read in miranda data - entire mRNA binding
```{r}
miranda_full <- read.delim("~/Desktop/PutnamLab/Astrangia/Molecular/miranda_strict_all_mrna_apoc_shortstack_parsed.txt", header = F)
colnames(miranda_full) <- c("miRNA", "mRNA", "score", "energy", "query_start_end", "subject_start_end", "total_bp_shared", "query_similar", "subject_similar")

# Format miranda df 
miranda_full$miRNA <- sub("^>", "", miranda_full$miRNA)  # Remove leading ">"
miranda_full$miRNA <- sub("\\..*", "", miranda_full$miRNA)  # Remove everything from the first period onwards
miranda_full$mRNA <- sub(";.*", "", miranda_full$mRNA)  # Remove everything from "::" onwards
miranda_full$mRNA <- sub("ID=", "", miranda_full$mRNA)  # Remove everything from "::" onwards
miranda_full$mRNA <- sub("model", "TU", miranda_full$mRNA)  # Remove everything from "::" onwards

dim(miranda_full)
length(unique(miranda_full$miRNA))
length(unique(miranda_full$mRNA))
```


Read in expressed genes file 
```{r}
filt_counts <- read.csv("../output/Molecular/mRNA/filtered_gene_counts.csv")
```

Join miranda and filtered gene counts df 
```{r}
miranda_full_exp <- miranda_full %>%
  left_join(filt_counts, by = c("mRNA" = "X")) %>%
  filter(if_all(starts_with("AST"), ~ !is.na(.)))

length(unique(miranda_full_exp$miRNA))
length(unique(miranda_full_exp$mRNA))
```

Count number of mRNA targets per miRNA
```{r}
# count unique mRNAs per miRNA
df_counts <- miranda_full_exp %>%
  group_by(miRNA) %>%
  summarise(num_targets = n_distinct(mRNA), .groups = "drop")
mean(df_counts$num_targets)
max(df_counts$num_targets)
min(df_counts$num_targets)

# bar plot
ggplot(df_counts, aes(x = reorder(miRNA, -num_targets), y = num_targets)) +
  geom_col(fill = "steelblue", width = 0.8) +  # width can be adjusted
  labs(
    x = "miRNA",
    y = "Number of mRNA targets"
  ) +
  scale_y_continuous(
    breaks = seq(0, 1100, by = 200),  # y-axis ticks every 250
    limits = c(0, 1100),              # y-axis goes from 0 to 1400
    expand = c(0, 0)                  # bars sit on x-axis
  ) +
  theme_classic(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
    axis.title = element_text(size = 14, face = "bold"))
```


Plot total bp shared distribution
```{r}
miranda_full_exp_filt <- miranda_full_exp %>%
  filter(total_bp_shared < 23) %>%
  filter(total_bp_shared > 5)
mean(miranda_full_exp_filt$total_bp_shared)
max(miranda_full_exp_filt$total_bp_shared)
min(miranda_full_exp_filt$total_bp_shared)

ggplot(miranda_full_exp_filt, aes(x = total_bp_shared)) +
  geom_histogram(
    aes(y = after_stat(count / sum(count))),
    binwidth = 1, fill = "steelblue", color = "black"
  ) +
  labs(
    x = "Total bp shared",
    y = "Frequency"
  ) +
  theme_classic2()

# calculate percentages per bin
df_freq <- miranda_full_exp_filt %>%
  count(total_bp_shared) %>%
  mutate(perc = n / sum(n) * 100)

ggplot(df_freq, aes(x = total_bp_shared, y = perc)) +
  # filled frequency curve
  geom_area(fill = "steelblue", alpha = 0.6) +
  geom_line(color = "steelblue", size = 1.2) +
  
  # axis labels & title
  labs(
    x = "Total bp shared",
    y = "Frequency (%)"
  ) +
  
  # axis breaks
  scale_x_continuous(breaks = seq(min(df_freq$total_bp_shared),
                                  max(df_freq$total_bp_shared), by = 2)) +
  scale_y_continuous(breaks = seq(0, max(df_freq$perc), by = 5)) +
  
  # clean minimal theme
  theme_classic(base_size = 14) +
  theme(
    axis.title = element_text(size = 16, face = "bold"),
    axis.text = element_text(size = 13, color = "black"),
    plot.margin = margin(10, 10, 10, 10)
  )

```

Read in miranda data - 3'UTR binding 
```{r}
miranda_3utr <- read.delim("../output/Molecular/interactions/miranda_strict_all_1kb_apoc_shortstack_parsed.txt", header = F)
colnames(miranda_3utr) <- c("miRNA", "mRNA", "score", "energy", "query_start_end", "subject_start_end", "total_bp_shared", "query_similar", "subject_similar")

# Format miranda df 
miranda_3utr$miRNA <- sub("^>", "", miranda_3utr$miRNA)  # Remove leading ">"
miranda_3utr$miRNA <- sub("\\..*", "", miranda_3utr$miRNA)  # Remove everything from the first period onwards
miranda_3utr$mRNA <- sub(";.*", "", miranda_3utr$mRNA)  # Remove everything from "::" onwards
miranda_3utr$mRNA <- sub("ID=", "", miranda_3utr$mRNA)  # Remove everything from "::" onwards
miranda_3utr$mRNA <- sub("model", "TU", miranda_3utr$mRNA)  # Remove everything from "::" onwards

dim(miranda_3utr)
length(unique(miranda_3utr$miRNA))
length(unique(miranda_3utr$mRNA))
```

Plot total bp shared distribution
```{r}
ggplot(miranda_3utr, aes(x = total_bp_shared)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "black") +
  labs(
    x = "Total bp shared",
    y = "Count"
  ) +
  theme_minimal()
```

How much overlap is there between these two datasets? 
```{r}
# Make a simple unique pair ID
miranda_full$pair <- paste(miranda_full$miRNA, miranda_full$mRNA, sep = "_")
miranda_3utr$pair <- paste(miranda_3utr$miRNA, miranda_3utr$mRNA, sep = "_")

# How many pairs are in each
length(unique(miranda_full$pair))
length(unique(miranda_3utr$pair))

# How many pairs overlap?
overlap_pairs <- intersect(miranda_full$pair, miranda_3utr$pair)
length(overlap_pairs)

# What % overlap?
length(overlap_pairs) / length(unique(miranda_3utr$pair)) * 100
length(overlap_pairs) / length(suunique(miranda_full$pair)) * 100
```

If a pair is found in both, do the scores differ? 
```{r}
# Keep only overlapping pairs
full_overlap <- miranda_full[miranda_full$pair %in% overlap_pairs, ]
utr_overlap <- miranda_3utr[miranda_3utr$pair %in% overlap_pairs, ]

# Merge by pair
merged <- merge(full_overlap, utr_overlap, by = "pair", suffixes = c("_full", "_3utr"))

# Compare scores/energy
plot(merged$score_full, merged$score_3utr, 
     xlab = "Full mRNA score", ylab = "3′UTR score")
abline(0, 1, col = "red")

plot(merged$energy_full, merged$energy_3utr,
     xlab = "Full mRNA energy", ylab = "3′UTR energy")
abline(0, 1, col = "red")

```

Summarize unique v shared
```{r}
only_full <- setdiff(miranda_full$pair, miranda_3utr$pair)
only_3utr <- setdiff(miranda_3utr$pair, miranda_full$pair)

length(only_full)
length(only_3utr)

summary_df <- data.frame(
  total_full = length(unique(miranda_full$pair)),
  total_3utr = length(unique(miranda_3utr$pair)),
  overlap = length(overlap_pairs),
  only_full = length(only_full),
  only_3utr = length(only_3utr)
)
summary_df
```

Maybe use them both...