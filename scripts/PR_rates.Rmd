---
title: "Photosynthesis and respiration rate calculations"
output: html_document
---

# PR data from experimental corals

Updated R/RStudio and packages are loading weirdly. Going to try to reinstall 
```{r}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("devtools")
BiocManager::install("furr")
BiocManager::install("future")
BiocManager::install("tidyverse", force = TRUE)
BiocManager::install("gridExtra")
BiocManager::install("ggpubr")
BiocManager::install("lubridate")
BiocManager::install("cowplot")
BiocManager::install("LoLinR")
#BiocManager::install("dplyr", force = TRUE)
```


## load packages
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

## install packages if you dont already have them in your library
if (!require("devtools")) install.packages("devtools")
if (!require("furrr")) install.packages("furrr")
if (!require("future")) install.packages("future")
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("gridExtra")) install.packages("gridExtra")
if (!require("ggpubr")) install.packages("ggpubr")
if (!require("lubridate")) install.packages("lubridate")
if (!require("cowplot")) install.packages("cowplot")
if (!require("LoLinR")) install_github('colin-olito/LoLinR') 

## load libraries
library(devtools)
library(LoLinR)
library(tidyverse)
library(gridExtra)
library(ggpubr)
library(lubridate)
library(cowplot)
#library(dplyr)
library(car)
library(emmeans)
library(lsmeans)
library(multcompView)

## libraries for parallel processing
library(future)
library(furrr)
```

## Set working directory 
```{r}
#setwd('/Users/jillashey/Desktop/PutnamLab/Repositories/Astrangia_repo/Astrangia_repo/')

#Warning: The working directory was changed to /Users/jillashey/Desktop/PutnamLab/Repositories/Astrangia_repo/Astrangia_repo inside a notebook chunk. The working directory will be reset when the chunk is finished running. Use the knitr root.dir option in the setup chunk to change the working directory for notebook chunks.
## working directory is being weird 
```


## Import data
```{r}
path.p <- "../data/Physiology/PR/raw" #the location of all your respirometry files 

# List data files
file.names <- list.files(path = path.p, pattern = "csv$")  # list all csv file names in the folder
file.names <- file.names[!grepl("metadata", file.names)]   # omit metadata from files to be read in as data

# Load PI curve sample metadata (i.e., which corals were in which runs)
sample.info <- read_csv("../data/Physiology/PR/PR_sample_metadata.csv")

# Load PI curve run metadata (i.e., light levels and interval times for each run)
run.info <- read_csv(file = "../data/Physiology/PR/PR_run_metadata.csv")

# Join all coral and run metadata
metadata <- full_join(sample.info, run.info) %>%
  mutate(Date = as_date(as.character(Date), format = "%Y%m%d", tz = "Tahiti"))

# Select only certain columnns
metadata <- metadata %>%
  select(colony_id, Run, Treatment,Chamber.Vol.L, Date, Start.time, Stop.time, Light_Value,Surface.Area.cm2)

# # Read in all data files
# df <- tibble(file.name = file.names) %>%
#   mutate(colony_id = gsub("_.*", "", file.name),                              # Get colony_id from filename
#           info = map(colony_id, ~filter(metadata, colony_id == .)),           # Get associated sample info
#          data0 = map(file.name, ~read_csv(file.path(path.p, .), skip = 1)))   # Get associated O2 data
# 
# # Select only Time, Value, and Temp columns from O2 data
# df <- df %>%
#   mutate(data0 = map(data0, ~select(., Time, Value, Temp))) %>% 
#   mutate(data0 = map(data0, ~(.x %>% filter(complete.cases(.))))) #remove NAs to get rid of artifact line in our data









df <- tibble(file.name = file.names) %>%
  mutate(colony_id = gsub("_.*", "", file.name),                              # Get colony_id from filename
          info = map(colony_id, ~filter(metadata, colony_id == .)),           # Get associated sample info
         data0 = map(file.name, ~read_csv(file.path(path.p, .), skip = 1, col_types = cols(.default = "d", Time = "t"))))   # Get associated O2 data
# Select only Time, Value, and Temp columns from O2 data
df <- df %>%
  mutate(data0 = map(data0, ~select(., Time, Value, Temp)))%>%
  mutate(data0 = map(data0, ~(.x %>% filter(complete.cases(.))))) #remove NAs to get rid of artifact line in our data
```

## Use the time breaks in the sample info to link O2 data with light levels
```{r}
# df <- df %>%
#   dplyr::mutate(intervals = map2(data0, info, function(.x, .y) {
#     split(.x, f = cut(as.numeric(.x$Time), breaks = as.numeric(c(.y$Start.time, last(.y$Stop.time))),
#                       labels = as.character(.y$Light_Value)))})) %>%
#   dplyr::mutate(data = map(intervals, ~ unnest(tibble(.), .id = "Light_Value")))
# 
# ## 'data' now contains the O2 data with the corresponding light level as another column
# ## Example of what 'data' for each sample looks like:
# #df$data[[1]]


df <- df %>%
  mutate(intervals = map2(data0, info, function(.x, .y) {
    split(.x, f = cut(as.numeric(.x$Time), breaks = as.numeric(c(.y$Start.time, last(.y$Stop.time))),
                      labels = as.character(.y$Light_Value)))})) %>%
  mutate(data = map(intervals, ~ unnest(tibble(.), .id = "Light_Value")))
```

### Thin data
```{r, fig.height = 8, fig.width = 8}
# Set thinning parameter
thin_par <- 20

# Thin data for all samples
df <- df %>%
  mutate(thin_data = map(data, ~ slice(., seq(1, nrow(.), thin_par))))

# Create plots for full dataset and thinned data
df <- df %>%
  mutate(data_plot = map2(data, colony_id, ~ ggplot(.x, aes(x = Time, y = Value)) + 
                            facet_wrap(~ as.numeric(Light_Value), scales = "free") +
                            geom_point() +
                            labs(title = .y)),
    thin_data_plot = map2(thin_data, colony_id, ~ ggplot(.x, aes(x = Time, y = Value)) + 
                            facet_wrap(~ as.numeric(Light_Value), scales = "free") +
                            geom_point() +
                            labs(title = .y)))

# Example of plots
cowplot::plot_grid(df$data_plot[[1]], df$thin_data_plot[[1]], nrow = 2,
                   labels = c("Example plot: all data", "Example plot: thinned data"))
```

#### The full or thinned data plot for any sample can be accessed like this:
```{r}
df %>%
  filter(colony_id == "AST-3002") %>%
  pull(thin_data_plot)
```

# Fit regressions to each interval for each sample
```{r}
# Define function for fitting LoLinR regressions to be applied to all intervals for all samples
fit_reg <- function(df) {
  rankLocReg(xall = as.numeric(df$Time), yall = df$Value, 
             alpha = 0.2, method = "pc", verbose = FALSE)
}

# Setup for parallel processing
future::plan()

# Map LoLinR function onto all intervals of each sample's thinned dataset
df <- df %>%
  mutate(regs = furrr::future_map(thin_data, function(.) {       # future_map executes function in parallel
    group_by(., Light_Value) %>%
    do(rankLcRg = fit_reg(.))
  }))

## Now 'regs' contains the fitted local regressions for each interval of each sample's thinned dataset

# Define function to pull out and plot regression diagnostics
plot_rankLcRg <- function(colony_id, interval_number) {
  df %>%
    filter(colony_id == colony_id) %>%
    pluck("regs", 1, "rankLcRg", interval_number) %>%
    plot()
}
```

#### The diagnostics for any regression can be plotted like this, specifying a colony_id and the number of the light curve interval:
```{r}
plot_rankLcRg("AST-1343", 1) 
```

### Extract slope of best regression for each interval for each sample
```{r}
df.out <- df %>% 
  unnest(regs) %>%
  mutate(micromol.L.s = map_dbl(rankLcRg, ~ pluck(., "allRegs", "b1", 1)))
```

# Adjust by chamber volume and normalize to surface area
```{r}
### Merge rates with sample info
pr <- left_join(
  select(df.out, colony_id, Light_Value, micromol.L.s),
  distinct(metadata, colony_id, Run, Treatment,Chamber.Vol.L, Surface.Area.cm2, Date)
)

### Correct for chamber volume and blanks
pr <- pr %>%
  mutate(micromol.s = micromol.L.s * Chamber.Vol.L)

# Get blank values -- average for each run and light value in case multiple blanks
blanks <- pr %>%
  filter(grepl("BK", colony_id)) %>%
  group_by(Run, Light_Value) %>%
  summarise(micromol.s.blank = mean(micromol.s))

# Join blank values with rest of data and subtract values from samples for same run and light value
pr <- left_join(pr, blanks) %>%
  mutate(micromol.s.adj = micromol.s - micromol.s.blank) %>%
  # After correcting for blank values, remove blanks from data
  filter(!grepl("BK", colony_id))


# Normalize rates by surface area
pr <- pr %>%
  mutate(micromol.cm2.s = micromol.s.adj / Surface.Area.cm2,
         micromol.cm2.h = micromol.cm2.s * 3600)
```

# Plot rates vs. irradiance for each sample
Now that we processed pr data, let's look at the data by timepoint 

## TP0 
```{r, fig.height=2, fig.width = 8}
tp0_pr <- pr %>% 
  filter(Date == "2021-02-04")

tp0_plot <- ggplot(tp0_pr, aes(x = as.numeric(Light_Value), y = micromol.cm2.h)) +
  geom_point() +
  facet_wrap(~colony_id*Light_Value); tp0_plot

ggsave("../output/Physiology/PR/TP0_PR.pdf", tp0_plot, width = 6, height = 10, units = c("in"))
```

## TP1
```{r, fig.height=2, fig.width = 8}
tp1_pr <- pr %>% 
  filter(Date == "2021-03-04")

tp1_plot <- ggplot(tp1_pr, aes(x = as.numeric(Light_Value), y = micromol.cm2.h)) +
  geom_point() +
  facet_wrap(~colony_id*Light_Value); tp1_plot

ggsave("../output/Physiology/PR/TP1_PR.pdf", tp1_plot, width = 6, height = 10, units = c("in"))
```






# Write to output file
```{r}
# Select variables to write to file
pr.out <- pr %>% select(colony_id, Light_Value, Run,Treatment, micromol.cm2.s, micromol.cm2.h, Date)

# Write to output file
write.csv(pr.out, "../output/Physiology/PR/PR_rates.csv")
```

```{r}
pr.save <- pr.out %>% select(colony_id, Light_Value, Run, Treatment, micromol.cm2.s, micromol.cm2.h, Date)

pr.save <- pr.save %>% 
  mutate(Timepoint = case_when(
    Date == "2021-02-04" ~ "TP0",
    Date == "2021-03-04" ~ "TP1",
    Date == "2021-04-01" ~ "TP2",
    Date == "2021-04-29" ~ "TP3",
    Date == "2021-05-27" ~ "TP4",
    Date == "2021-06-24" ~ "TP5", 
    Date == "2021-07-22" ~ "TP6",
    Date == "2021-08-19" ~ "TP7"))


pr.save <- pr.save %>% 
  mutate(Assay = case_when(
    Light_Value == "0" ~ "Rd",
    Light_Value == "320" ~ "P",
    Light_Value == "350" ~ "P",
    Light_Value == "368" ~ "P",
    Light_Value == "337" ~ "P",
    Light_Value == "355" ~ "P",
    Light_Value == "361" ~ "P", 
    Light_Value == "334" ~ "P",
    Light_Value == "358" ~ "P"))

gd <- pr.save %>% 
        group_by(Assay,Timepoint,Treatment) %>% 
        summarise(avg = mean(micromol.cm2.h),
                  sem  = sd(micromol.cm2.h)/sqrt(length((micromol.cm2.h))))

trt.plot <- ggplot(pr.save, aes(x = Timepoint, y = micromol.cm2.h, group=Treatment)) +
   geom_point(alpha = .4, aes(colour = Treatment), size = 2) +
    geom_point(data = gd, aes(x = Timepoint, y = avg, group=Treatment, colour = Treatment), size=4)+
    scale_color_manual(values=c('black','blue', 'red'))+
    #geom_errorbar(data = gd, aes(ymin=avg-sem, ymax=avg+sem)) +
  geom_point(data = gd, aes(x = Timepoint, y = avg-sem, group=Treatment, colour = Treatment), size=2, shape=8)+
  geom_point(data = gd, aes(x = Timepoint, y = avg+sem, group=Treatment, colour = Treatment), size=2, shape=8)+
   geom_line(data = gd, aes(x = Timepoint, y = avg, group=Treatment, colour = Treatment)) +
   #ylim(-0.4,0.5) +
  facet_wrap(~Assay, ncol = 2)+
   theme_bw()+
  theme(legend.position = c(0.63, 0.8),
        legend.title = element_text(colour="black", size=6, 
                                     face="bold"),
        legend.text = element_text(size=4))+
  theme(text = element_text(size=15),
        axis.text.x = element_text(angle=90, hjust=1)) +
  guides(color = guide_legend(override.aes = list(size = 1))); trt.plot

plot <- grid.arrange(trt.plot, clip="off")
ggsave("output/Physiology/PR/Timepoint.Treatment_PR.pdf", plot, width = 6, height = 5, units = c("in"))


# # Individual plots for each sample 
# indiv = ggplot(pr.save, aes(x = as.numeric(Light_Value), y = micromol.cm2.h)) +
#    geom_point(alpha = .4, aes(colour = Treatment)) +
#    ylim(-0.3,0.5)+
#    #geom_point(data = gd, size = 4) +
#    theme_bw() +
#    facet_wrap(~colony_id, ncol = 3)
# ggsave("../output/PR/IndividualSample_PR.pdf", indiv, width = 21, height = 21, units = c("in"))
# 
# 
# p2 = ggplot(pr.save, aes(x = Timepoint, y = micromol.cm2.h)) +
#    geom_point(alpha = .4, aes(colour = Treatment, shape = Light_Value), size = 4) +
#    ylim(-0.3,0.5) +
#    #geom_point(data = gd, size = 4) +
#    theme_bw()
# p2 + scale_color_manual(values = c("black", "blue", "red"))
```




#################### PR data from field corals #################### 
## Import data
```{r}
path.p <- "data/Physiology/PR/raw_field" #the location of all your respirometry files 

# List data files
file.names <- list.files(path = path.p, pattern = "csv$")  # list all csv file names in the folder
file.names <- file.names[!grepl("metadata", file.names)]   # omit metadata from files to be read in as data

# Load PI curve sample metadata (i.e., which corals were in which runs)
sample.info <- read_csv(file = "data/Physiology/PR/PR_field_sample_metadata.csv")

# Load PI curve run metadata (i.e., light levels and interval times for each run)
run.info <- read_csv(file = "data/Physiology/PR/PR_field_run_metadata.csv")

# Join all coral and run metadata
metadata <- full_join(sample.info, run.info) %>%
  mutate(Date = as_date(as.character(Date), format = "%Y%m%d", tz = "Tahiti"))

# Select only certain columnns
metadata <- metadata %>%
  select(colony_id, Run, Treatment,Chamber.Vol.L, Date, Start.time, Stop.time, Light_Value,Surface.Area.cm2)

# Read in all data
df <- tibble(file.name = file.names) %>%
  mutate(colony_id = gsub("_.*", "", file.name),                              # Get colony_id from filename
          info = map(colony_id, ~filter(metadata, colony_id == .)),           # Get associated sample info
         data0 = map(file.name, ~read_csv(file.path(path.p, .), skip = 1, col_types = cols(.default = "d", Time = "t"))))   # Get associated O2 data

# Select only Time, Value, and Temp columns from O2 data
df <- df %>%
  mutate(data0 = map(data0, ~select(., Time, Value, Temp)))%>%
  mutate(data0 = map(data0, ~(.x %>% filter(complete.cases(.))))) #remove NAs to get rid of artifact line in our data 
```


## Use the time breaks in the sample info to link O2 data with light levels
```{r, warning = FALSE}
df <- df %>%
  mutate(intervals = map2(data0, info, function(.x, .y) {
    split(.x, f = cut(as.numeric(.x$Time), breaks = as.numeric(c(.y$Start.time, last(.y$Stop.time))),
                      labels = as.character(.y$Light_Value)))})) %>%
  mutate(data = map(intervals, ~ unnest(tibble(.), .id = "Light_Value")))

## 'data' now contains the O2 data with the corresponding light level as another column
## Example of what 'data' for each sample looks like:
# df$data[[1]]
```

### Thin data
```{r, fig.height = 8, fig.width = 8}
# Set thinning parameter
thin_par <- 20

# Thin data for all samples
df <- df %>%
  mutate(thin_data = map(data, ~ slice(., seq(1, nrow(.), thin_par))))

# Create plots for full dataset and thinned data
df <- df %>%
  mutate(data_plot = map2(data, colony_id, ~ ggplot(.x, aes(x = Time, y = Value)) + 
                            facet_wrap(~ as.numeric(Light_Value), scales = "free") +
                            geom_point() +
                            labs(title = .y)),
    thin_data_plot = map2(thin_data, colony_id, ~ ggplot(.x, aes(x = Time, y = Value)) + 
                            facet_wrap(~ as.numeric(Light_Value), scales = "free") +
                            geom_point() +
                            labs(title = .y)))

# Example of plots
cowplot::plot_grid(df$data_plot[[1]], df$thin_data_plot[[1]], nrow = 2,
                   labels = c("Example plot: all data", "Example plot: thinned data"))
```

#### The full or thinned data plot for any sample can be accessed like this:
```{r}
df %>%
  filter(colony_id == "FLD-0015") %>%
  pull(thin_data_plot)
```

# Fit regressions to each interval for each sample
```{r}
# Define function for fitting LoLinR regressions to be applied to all intervals for all samples
fit_reg <- function(df) {
  rankLocReg(xall = as.numeric(df$Time), yall = df$Value, 
             alpha = 0.2, method = "pc", verbose = FALSE)
}

# Setup for parallel processing
future::plan()

# Map LoLinR function onto all intervals of each sample's thinned dataset
df <- df %>%
  mutate(regs = furrr::future_map(thin_data, function(.) {       # future_map executes function in parallel
    group_by(., Light_Value) %>%
    do(rankLcRg = fit_reg(.))
  }))

## Now 'regs' contains the fitted local regressions for each interval of each sample's thinned dataset

# Define function to pull out and plot regression diagnostics
plot_rankLcRg <- function(colony_id, interval_number) {
  df %>%
    filter(colony_id == colony_id) %>%
    pluck("regs", 1, "rankLcRg", interval_number) %>%
    plot()
}
```

#### The diagnostics for any regression can be plotted like this, specifying a colony_id and the number of the light curve interval:
```{r}
plot_rankLcRg("FLD-0037", 1) 
```

### Extract slope of best regression for each interval for each sample
```{r}
df.out <- df %>% 
  unnest(regs) %>%
  mutate(micromol.L.s = map_dbl(rankLcRg, ~ pluck(., "allRegs", "b1", 1)))
```

# Adjust by chamber volume and normalize to surface area
```{r}
### Merge rates with sample info
pr <- left_join(
  select(df.out, colony_id, Light_Value, micromol.L.s),
  distinct(metadata, colony_id, Run, Treatment,Chamber.Vol.L, Surface.Area.cm2, Date)
)

### Correct for chamber volume and blanks
pr <- pr %>%
  mutate(micromol.s = micromol.L.s * Chamber.Vol.L)

# Get blank values -- average for each run and light value in case multiple blanks
blanks <- pr %>%
  filter(grepl("BK", colony_id)) %>%
  group_by(Run, Light_Value) %>%
  summarise(micromol.s.blank = mean(micromol.s))

# Join blank values with rest of data and subtract values from samples for same run and light value
pr <- left_join(pr, blanks) %>%
  mutate(micromol.s.adj = micromol.s - micromol.s.blank) %>%
  # After correcting for blank values, remove blanks from data
  filter(!grepl("BK", colony_id))

# Normalize rates by surface area
pr <- pr %>%
  mutate(micromol.cm2.s = micromol.s.adj / Surface.Area.cm2,
         micromol.cm2.h = micromol.cm2.s * 3600)
```

# Plot rates vs. irradiance for each sample
```{r, fig.height=2, fig.width = 8}
ggplot(pr, aes(x = as.numeric(Light_Value), y = micromol.cm2.h)) +
  geom_point() +
  facet_wrap(~colony_id*Light_Value, ncol = 9)
```

# Write to output file
```{r}
# Select variables to write to file
pr.out <- pr %>% select(colony_id, Light_Value, Run,Treatment, micromol.cm2.s, micromol.cm2.h, Date)

# Write to output file
write.csv(pr.out, "output/Physiology/PR/PR_field_rates.csv")
```

```{r}
pr.save <- pr.out %>% select(colony_id, Light_Value, Run, Treatment, micromol.cm2.s, micromol.cm2.h, Date)

gd <- pr.save %>% group_by(Light_Value) %>% 
        summarise(avg = mean(micromol.cm2.h),
          sem = sd(micromol.cm2.h))

pr.save <- pr.save %>% 
  mutate(Timepoint = case_when(
    Date == "2021-04-10" ~ "FLD-TP2",
    Date == "2021-04-30" ~ "FLD-TP3",
    Date == "2021-06-02" ~ "FLD-TP4",
    Date == "2021-06-25" ~ "FLD-TP5",
    Date == "2021-07-23" ~ "FLD-TP6",
    Date == "2021-09-01" ~ "FLD-TP7"))


pr.save <- pr.save %>% 
  mutate(Assay = case_when(
    Light_Value == "0" ~ "Rd",
    Light_Value == "340" ~ "P",
    Light_Value == "392" ~ "P",
    Light_Value == "321" ~ "P",
    Light_Value == "319" ~ "P",
    Light_Value == "366" ~ "P",
    Light_Value == "342" ~ "P"))

gd <- pr.save %>% 
        group_by(Assay,Timepoint,Treatment) %>% 
        summarise(avg = mean(micromol.cm2.h),
                  sem  = sd(micromol.cm2.h)/sqrt(length((micromol.cm2.h))))

field_trt.plot <- ggplot(pr.save, aes(x = Timepoint, y = micromol.cm2.h, group=Treatment)) +
   geom_point(alpha = .4, aes(colour = Treatment), size = 2) +
    geom_point(data = gd, aes(x = Timepoint, y = avg, group=Treatment, colour = Treatment), size=4)+
    #scale_color_manual(values=c('black','blue', 'red'))+
    #geom_errorbar(data = gd, aes(ymin=avg-sem, ymax=avg+sem)) +
  geom_point(data = gd, aes(x = Timepoint, y = avg-sem, group=Treatment, colour = Treatment), size=2, shape=8)+
  geom_point(data = gd, aes(x = Timepoint, y = avg+sem, group=Treatment, colour = Treatment), size=2, shape=8)+
   geom_line(data = gd, aes(x = Timepoint, y = avg, group=Treatment, colour = Treatment)) +
   #ylim(-0.4,0.5) +
  facet_wrap(~Assay, ncol = 2)+
   theme_bw()+
  theme(legend.position = c(0.63, 0.8),
        legend.title = element_text(colour="black", size=6, 
                                     face="bold"),
        legend.text = element_text(size=4))+
  guides(color = guide_legend(override.aes = list(size = 1)))
field_trt.plot

plot <- grid.arrange(field_trt.plot, clip="off")
ggsave("output/Physiology/PR/Field_Timepoint.Treatment_PR.pdf", plot, width = 4, height = 3.5, units = c("in"))


# # Individual plots for each sample 
# indiv = ggplot(pr.save, aes(x = as.numeric(Light_Value), y = micromol.cm2.h)) +
#    geom_point(alpha = .4, aes(colour = Treatment)) +
#    ylim(-0.3,0.5)+
#    #geom_point(data = gd, size = 4) +
#    theme_bw() +
#    facet_wrap(~colony_id, ncol = 3)
# ggsave("../output/PR/IndividualSample_PR.pdf", indiv, width = 21, height = 21, units = c("in"))
# 
# 
# p2 = ggplot(pr.save, aes(x = Timepoint, y = micromol.cm2.h)) +
#    geom_point(alpha = .4, aes(colour = Treatment, shape = Light_Value), size = 4) +
#    ylim(-0.3,0.5) +
#    #geom_point(data = gd, size = 4) +
#    theme_bw()
# p2 + scale_color_manual(values = c("black", "blue", "red"))
```

## Bind experimental and field plots 
```{r}
figure <- ggarrange(trt.plot, field_trt.plot,
                    #labels = c("A", "B", "C"),
                    ncol = 1, nrow = 2)
figure

plot <- grid.arrange(figure, clip="off")
ggsave("output/Physiology/PR/Combination.Exp.Fld_Timepoint.Treatment_PR.pdf", plot, width = 4, height = 7, units = c("in"))
```

# Stats and plotting - 20250317

## Photosynthesis 

Read in data
```{r}
exp <- read_csv(file = "../output/Physiology/PR/PR_rates.csv")

photo_exp <- exp %>%
  filter(Light_Value > 0)
```

Check for outliers
```{r}
# Look for outliers visually
ggplot(photo_exp, aes(x = Treatment, y = micromol.cm2.h)) + 
  geom_boxplot(outlier.color = "red", outlier.shape = 16) +
  theme_minimal()

# IQR method 
Q1 <- quantile(photo_exp$micromol.cm2.h, 0.25)
Q3 <- quantile(photo_exp$micromol.cm2.h, 0.75)
IQR_val <- Q3 - Q1

lower_bound <- Q1 - 1.5 * IQR_val
upper_bound <- Q3 + 1.5 * IQR_val
outliers <- photo_exp[photo_exp$micromol.cm2.h < lower_bound | photo_exp$micromol.cm2.h > upper_bound, ]
print(outliers)

# Z-score method
photo_exp$z_score <- scale(photo_exp$micromol.cm2.h)
outliers_z <- photo_exp[abs(photo_exp$z_score) > 3, ]
print(outliers_z)
```

Remove outliers based on IQR
```{r}
# Calculate IQR
Q1 <- quantile(photo_exp$micromol.cm2.h, 0.25)
Q3 <- quantile(photo_exp$micromol.cm2.h, 0.75)
IQR_val <- Q3 - Q1

lower_bound <- Q1 - 1.5 * IQR_val
upper_bound <- Q3 + 1.5 * IQR_val

# Filter dataset to remove outliers
photo_exp_filtered <- photo_exp[photo_exp$micromol.cm2.h >= lower_bound & photo_exp$micromol.cm2.h <= upper_bound, ]

# Check dimensions before and after
dim(photo_exp)
dim(photo_exp_filtered)
```

15 outliers removed. 

Assess normality of data 
```{r}
# Histogram
ggplot(photo_exp_filtered, aes(x = micromol.cm2.h)) + 
  geom_histogram(bins = 30, fill = "skyblue", color = "black") + 
  theme_minimal()

# Q-Q Plot
qqnorm(photo_exp_filtered$micromol.cm2.h)
qqline(photo_exp_filtered$micromol.cm2.h, col = "red")

# Shapiro-Wilk Test
shapiro.test(photo_exp_filtered$micromol.cm2.h)
```

Data is normal. Set date as Timepoints
```{r}
photo_exp_filtered <- photo_exp_filtered %>%
  mutate(Timepoint = case_when(
    Date == "2021-02-04" ~ "TP0",
    Date == "2021-03-04" ~ "TP1",
    Date == "2021-04-01" ~ "TP2",
    Date == "2021-04-29" ~ "TP3",
    Date == "2021-05-27" ~ "TP4",
    Date == "2021-06-24" ~ "TP5",
    Date == "2021-07-22" ~ "TP6",
    Date == "2021-08-19" ~ "TP7")) 
```

Set TP0 to Ambient for stats purposes
```{r}
photo_exp_filtered <- photo_exp_filtered %>%
  mutate(Treatment = ifelse(Timepoint == "TP0", "Ambient", as.character(Treatment)))
```

Run a two-way ANOVA
```{r}
# Ensure factors are properly set
photo_exp_filtered$Treatment <- as.factor(photo_exp_filtered$Treatment)
photo_exp_filtered$Timepoint <- as.factor(photo_exp_filtered$Timepoint)

# Run two-way ANOVA
anova_result <- aov(micromol.cm2.h ~ Treatment * Timepoint, data = photo_exp_filtered)
summary(anova_result)

# Check for homogenity of variance 
leveneTest(micromol.cm2.h ~ Treatment * Timepoint, data = photo_exp_filtered)

# Check residuals 
# Residuals vs Fitted Plot (Check homoscedasticity)
plot(anova_result, which = 1)

# Q-Q Plot of Residuals (Check normality)
plot(anova_result, which = 2)
```

Timepoint is significant but Treatment and interaction is not. 

Run post-hoc test for Timepoint
```{r}
tukey_result <- TukeyHSD(anova_result, "Timepoint", conf.level = 0.95)
print(tukey_result)

plot(TukeyHSD(anova_result, conf.level=.95), las = 2)
```

Format data for plotting 
```{r}
# Assign month to TPs 
photo_exp_filtered <- photo_exp_filtered %>% 
  mutate(Month = case_when(
    Timepoint == "TP0" ~ "February", 
    Timepoint == "TP1" ~ "March", 
    Timepoint == "TP2" ~ "Early April", 
    Timepoint == "TP3" ~ "Late April", 
    Timepoint == "TP4" ~ "May", 
    Timepoint == "TP5" ~ "June", 
    Timepoint == "TP6" ~ "July", 
    Timepoint == "TP7" ~ "August")) 

# Update to Acclimation for plotting purposes 
photo_exp_filtered <- photo_exp_filtered %>%
  mutate(Treatment = ifelse(Month == "February", "Acclimation", as.character(Treatment))) %>%
  mutate(Treatment = as.factor(Treatment))
```

Plot 
```{r}
anova_summary <- summary(anova_result)

# Extract p-values
p_treatment <- anova_summary[[1]]$`Pr(>F)`[1]  # Treatment p-value
p_timepoint <- anova_summary[[1]]$`Pr(>F)`[2]  # Timepoint p-value
p_interaction <- anova_summary[[1]]$`Pr(>F)`[3]  # Interaction p-value

# Format text for annotation
anova_text <- paste0("Two-way ANOVA Results:",
                     "Treatment p = ", signif(p_treatment, 3),
                     "Timepoint p = ", signif(p_timepoint, 3),
                     "Interaction p = ", signif(p_interaction, 3))

# Set Month as factor 
photo_exp_filtered$Month <- factor(photo_exp_filtered$Month, levels = c("February", "March", "Early April", "Late April", "May", "June", "July", "August"))

# Create the plot
photo <- ggplot(photo_exp_filtered, aes(x = Month, y = micromol.cm2.h, fill = Treatment, color = Treatment)) + 
  geom_hline(yintercept = 0, color = "black", linetype = "dotted")+
  geom_boxplot(alpha = 0.6, outlier.shape = NA, size = 1) +  
  geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.7, size = 4) + 
  #geom_hline(yintercept = 0, color = "black", linetype = "dotted")+
  theme_classic() +
  xlab("") +
  ylab(expression(bold('Net Photosynthesis ('*mu~ 'mol' ~cm^-2*~ h^-1*')'))) +
  scale_fill_manual(values = c("grey", "blue", "red")) +
  scale_colour_manual(values = c("grey","blue", "red")) + 
  theme(legend.title = element_text(size = 28, face = "bold"),
          legend.text = element_text(size = 15),
          legend.position = "right",
          legend.key.size = unit(3, "line")) +
  theme(axis.text.x = element_text(size = 25,
                                   color = "black",
                                   angle = 45,
                                   hjust = 1, 
                                   face = "bold"),
        axis.ticks.x = element_line(size = 1),
        axis.ticks.length = unit(0.3, "cm"),
        axis.text.y = element_text(size = 25,
                                   color = "black"),
        axis.title.y = element_text(face = "bold", size = 30,
                                    margin = margin(t = 0, r = 20, b = 0, l = 0))); photo
  #annotate("text", x = max(as.numeric(chl_exp_filtered$Timepoint)) - 0.2, 
  #         y = max(chl_exp_filtered$chla_sqrt), label = anova_text, 
  #         hjust = 1, vjust = 1, size = 5, color = "black")

ggsave("../output/Physiology/PR/NetPhoto_Treatment_Timepoint.pdf", photo, width = 20, height = 15)
ggsave("../output/Physiology/PR/NetPhoto_Treatment_Timepoint.png", photo, width = 20, height = 15)
```

Calculate mean, sd and sem of each group for plotting 
```{r}
photo_summary <- photo_exp_filtered %>%
  group_by(Treatment, Month) %>%
  dplyr::summarize(
    n = n(),  # Count observations per group
    mean_photo = mean(micromol.cm2.h, na.rm = TRUE),
    sd_photo = sd(micromol.cm2.h, na.rm = TRUE),
    sem_photo = sd_photo / sqrt(n),  # Correct SEM formula
    .groups = "drop"
  )
```

Obtain significance letters 
```{r}
# Extract the p.adjust values and names of comparisons
pvals <- tukey_result$Timepoint[, "p adj"]

# Set names for pvals as "TP1-TP0" etc. (they are already named like that in the TukeyHSD output)
names(pvals) <- rownames(tukey_result$Timepoint)

# Generate letters for significance groups
sig_letters <- multcompLetters(pvals, threshold = 0.05)

# View assigned letters for each timepoint
print(sig_letters$Letters)
```

Add letters for plotting 
```{r}
month_letters_manual <- tibble::tibble(
  Month = c("February", "March", "Early April", "Late April", "May", "June", "July", "August"),
  Letters = c("abc", "ab", "a", "a", "bc", "c", "c", "bc"),
  y_position = c(6.77, 3.67, 3.44, 4.28, 8.51, 7.33, 8.71, 7.20) # 0.5 offset from highest sd 
)
```

Plot as dot and whisker plots
```{r}
# Set Month as factor 
photo_summary$Month <- factor(photo_summary$Month, levels = c("February", "March", "Early April", "Late April", "May", "June", "July", "August"))

# sem
photo_dot_sem <- ggplot(photo_summary, aes(x = Month, y = mean_photo, color = Treatment)) +
  geom_line(aes(group = Treatment), linewidth = 1.5) +  # Connection lines
  geom_errorbar(aes(ymin = mean_photo - sem_photo, 
                    ymax = mean_photo + sem_photo), 
                width = 0.2) +
  geom_point(size = 5, aes(fill = Treatment), shape = 21, color = "black") +
  geom_text(data = month_letters_manual,
            aes(x = Month, y = y_position, label = Letters),
            inherit.aes = FALSE,
            position = position_dodge(width = 0.5),
            size = 10) +
  #geom_text(aes(label = Letters, y = mean_photo + sem_photo + 0.8),
  #          size = 6,
  #          color = "black",
  #          position = position_dodge(width = 0.5)) +
  xlab("") +
  ylab(expression(bold('Net Photosynthesis ('*mu~ 'mol' ~cm^-2*~ h^-1*')'))) +
  scale_color_manual(values = c("Acclimation" = "grey60", 
                               "Ambient" = "#377EB8",  # Blue
                               "Heat" = "#E41A1C")) +  # Red
  scale_fill_manual(values = c("Acclimation" = "grey80", 
                              "Ambient" = "#377EB8", 
                              "Heat" = "#E41A1C")) +
  theme_classic(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "top"); photo_dot_sem
ggsave("../output/Physiology/PR/NetPhoto_Treatment_Timepoin_dotwhisker_sem.pdf", photo_dot_sem, width = 20, height = 15)
ggsave("../output/Physiology/PR/NetPhoto_Treatment_Timepoin_dotwhisker_sem.png", photo_dot_sem, width = 20, height = 15)

# sd
photo_dot_sd <- ggplot(photo_summary, aes(x = Month, y = mean_photo, color = Treatment)) +
  geom_hline(yintercept = 0, color = "black", linetype = "dotted", linewidth = 1)+
  geom_line(aes(group = Treatment), linewidth = 4) +
  geom_errorbar(aes(ymin = mean_photo - sd_photo, 
                    ymax = mean_photo + sd_photo),
                linewidth = 2,  # Thicker error bars
                width = 0.5) +
  geom_point(size = 10, aes(fill = Treatment), 
             shape = 21, color = "black", stroke = 2) +  # Thicker point borders
  #geom_text(aes(label = Letters, y = mean_photo + sem_photo + 0.8),
  #          size = 6,
  #          color = "black",
  #          position = position_dodge(width = 0.5)) +
  geom_text(data = month_letters_manual,
            aes(x = Month, y = y_position, label = Letters),
            inherit.aes = FALSE,
            position = position_dodge(width = 0.5),
            size = 10) +
  scale_color_manual(values = c("Acclimation" = "grey60", 
                               "Ambient" = "#377EB8",
                               "Heat" = "#E41A1C")) +
  scale_fill_manual(values = c("Acclimation" = "grey80", 
                              "Ambient" = "#377EB8", 
                              "Heat" = "#E41A1C")) +
  xlab("") +
  ylab(expression(bold('Net Photosynthesis ('*mu~ 'mol' ~cm^-2*~ h^-1*')'))) +
  theme_classic() +  # Increased base font size
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 30, face = "bold", color = "black"),
    axis.text.y = element_text(size = 30, face = "bold", color = "black"),
    axis.title.y = element_text(size = 40, margin = margin(r = 15)),
    axis.ticks.x = element_line(size = 1, color = "black"),
    axis.ticks.length = unit(0.3, "cm"),
    legend.title = element_text(size = 35, face = "bold"),
    legend.text = element_text(size = 25),
    legend.position = "top",
    legend.key.size = unit(1.5, "cm"),
    legend.spacing.y = unit(0.5, "cm")
  );photo_dot_sd
ggsave("../output/Physiology/PR/NetPhoto_Treatment_Timepoin_dotwhisker_sd.pdf", photo_dot_sd, width = 22, height = 12)
ggsave("../output/Physiology/PR/NetPhoto_Treatment_Timepoin_dotwhisker_sd.png", photo_dot_sd, width = 22, height = 12)
```


## Respiration 

Read in data
```{r}
exp <- read_csv(file = "../output/Physiology/PR/PR_rates.csv")

resp_exp <- exp %>%
  filter(Light_Value == 0)
```

Check for outliers
```{r}
# Look for outliers visually
ggplot(resp_exp, aes(x = Treatment, y = micromol.cm2.h)) + 
  geom_boxplot(outlier.color = "red", outlier.shape = 16) +
  theme_minimal()

# IQR method 
Q1 <- quantile(resp_exp$micromol.cm2.h, 0.25)
Q3 <- quantile(resp_exp$micromol.cm2.h, 0.75)
IQR_val <- Q3 - Q1

lower_bound <- Q1 - 1.5 * IQR_val
upper_bound <- Q3 + 1.5 * IQR_val
outliers <- resp_exp[resp_exp$micromol.cm2.h < lower_bound | resp_exp$micromol.cm2.h > upper_bound, ]
print(outliers)

# Z-score method
resp_exp$z_score <- scale(resp_exp$micromol.cm2.h)
outliers_z <- resp_exp[abs(resp_exp$z_score) > 3, ]
print(outliers_z)
```

Remove outliers based on IQR
```{r}
# Calculate IQR
Q1 <- quantile(resp_exp$micromol.cm2.h, 0.25)
Q3 <- quantile(resp_exp$micromol.cm2.h, 0.75)
IQR_val <- Q3 - Q1

lower_bound <- Q1 - 1.5 * IQR_val
upper_bound <- Q3 + 1.5 * IQR_val

# Filter dataset to remove outliers
resp_exp_filtered <- resp_exp[resp_exp$micromol.cm2.h >= lower_bound & resp_exp$micromol.cm2.h <= upper_bound, ]

# Check dimensions before and after
dim(resp_exp)
dim(resp_exp_filtered)
```

13 outliers removed. 

Assess normality of data 
```{r}
# Histogram
ggplot(resp_exp_filtered, aes(x = micromol.cm2.h)) + 
  geom_histogram(bins = 30, fill = "skyblue", color = "black") + 
  theme_minimal()

# Q-Q Plot
qqnorm(resp_exp_filtered$micromol.cm2.h)
qqline(resp_exp_filtered$micromol.cm2.h, col = "red")

# Shapiro-Wilk Test
shapiro.test(resp_exp_filtered$micromol.cm2.h)
```

Data is normal. Set date as Timepoints
```{r}
resp_exp_filtered <- resp_exp_filtered %>%
  mutate(Timepoint = case_when(
    Date == "2021-02-04" ~ "TP0",
    Date == "2021-03-04" ~ "TP1",
    Date == "2021-04-01" ~ "TP2",
    Date == "2021-04-29" ~ "TP3",
    Date == "2021-05-27" ~ "TP4",
    Date == "2021-06-24" ~ "TP5",
    Date == "2021-07-22" ~ "TP6",
    Date == "2021-08-19" ~ "TP7")) 
```

Set TP0 to Ambient for stats purposes
```{r}
resp_exp_filtered <- resp_exp_filtered %>%
  mutate(Treatment = ifelse(Timepoint == "TP0", "Ambient", as.character(Treatment)))
```

Run a two-way ANOVA
```{r}
# Ensure factors are properly set
resp_exp_filtered$Treatment <- as.factor(resp_exp_filtered$Treatment)
resp_exp_filtered$Timepoint <- as.factor(resp_exp_filtered$Timepoint)

# Run two-way ANOVA
anova_result <- aov(micromol.cm2.h ~ Treatment * Timepoint, data = resp_exp_filtered)
summary(anova_result)

# Check for homogenity of variance 
leveneTest(micromol.cm2.h ~ Treatment * Timepoint, data = resp_exp_filtered)

# Check residuals 
# Residuals vs Fitted Plot (Check homoscedasticity)
plot(anova_result, which = 1)

# Q-Q Plot of Residuals (Check normality)
plot(anova_result, which = 2)
```

Run post hoc test 
```{r}
# Using emmeans to perform pairwise comparisons of the interaction
emm_interaction <- emmeans(anova_result, ~ Timepoint * Treatment)

# Conduct pairwise comparisons for the interaction
pairwise_interaction <- pairs(emm_interaction)

# View the results
summary(pairwise_interaction)

pairwise_df <- as.data.frame(summary(pairwise_interaction))
pairwise_df <- na.omit(pairwise_df)

# Look at Tukey as well
tukey_result<- TukeyHSD(anova_result, "Timepoint", conf.level = 0.95)
print(tukey_result)
TukeyHSD(anova_result, "Treatment", conf.level = 0.95)
```

Format data for plotting 
```{r}
# Assign month to TPs 
resp_exp_filtered <- resp_exp_filtered %>% 
  mutate(Month = case_when(
    Timepoint == "TP0" ~ "February", 
    Timepoint == "TP1" ~ "March", 
    Timepoint == "TP2" ~ "Early April", 
    Timepoint == "TP3" ~ "Late April", 
    Timepoint == "TP4" ~ "May", 
    Timepoint == "TP5" ~ "June", 
    Timepoint == "TP6" ~ "July", 
    Timepoint == "TP7" ~ "August")) 

# Update to Acclimation
resp_exp_filtered <- resp_exp_filtered %>%
  mutate(Treatment = ifelse(Month == "February", "Acclimation", as.character(Treatment))) %>%
  mutate(Treatment = as.factor(Treatment))
```

Plot 
```{r}
anova_summary <- summary(anova_result)

# Extract p-values
p_treatment <- anova_summary[[1]]$`Pr(>F)`[1]  # Treatment p-value
p_timepoint <- anova_summary[[1]]$`Pr(>F)`[2]  # Timepoint p-value
p_interaction <- anova_summary[[1]]$`Pr(>F)`[3]  # Interaction p-value

# Format text for annotation
anova_text <- paste0("Two-way ANOVA Results:",
                     "Treatment p = ", signif(p_treatment, 3),
                     "Timepoint p = ", signif(p_timepoint, 3),
                     "Interaction p = ", signif(p_interaction, 3))

# Set Month as factor 
resp_exp_filtered$Month <- factor(resp_exp_filtered$Month, levels = c("February", "March", "Early April", "Late April", "May", "June", "July", "August"))

# Create the plot
resp <- ggplot(resp_exp_filtered, aes(x = Month, y = micromol.cm2.h, fill = Treatment, color = Treatment)) + 
  geom_hline(yintercept = 0, color = "black", linetype = "dotted")+
  geom_boxplot(alpha = 0.6, outlier.shape = NA, size = 1) +  
  geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.7, size = 4) + 
  #geom_hline(yintercept = 0, color = "black", linetype = "dotted")+
  theme_classic() +
  xlab("") +
  ylab(expression(bold('Respiration ('*mu~ 'mol' ~cm^-2*~ h^-1*')'))) +
  scale_fill_manual(values = c("grey", "blue", "red")) +
  scale_colour_manual(values = c("grey","blue", "red")) + 
  theme(legend.title = element_text(size = 28, face = "bold"),
          legend.text = element_text(size = 15),
          legend.position = "right",
          legend.key.size = unit(3, "line")) +
  theme(axis.text.x = element_text(size = 25,
                                   color = "black",
                                   angle = 45,
                                   hjust = 1, 
                                   face = "bold"),
        axis.ticks.x = element_line(size = 1),
        axis.ticks.length = unit(0.3, "cm"),
        axis.text.y = element_text(size = 25,
                                   color = "black"),
        axis.title.y = element_text(face = "bold", size = 30,
                                    margin = margin(t = 0, r = 20, b = 0, l = 0))); resp
  #annotate("text", x = max(as.numeric(chl_exp_filtered$Timepoint)) - 0.2, 
  #         y = max(chl_exp_filtered$chla_sqrt), label = anova_text, 
  #         hjust = 1, vjust = 1, size = 5, color = "black")

ggsave("../output/Physiology/PR/Respiration_Treatment_Timepoint.pdf", resp, width = 20, height = 15)
ggsave("../output/Physiology/PR/Respiration_Treatment_Timepoint.png", resp, width = 20, height = 15)
```

Calculate mean, sd and sem of each group for plotting 
```{r}
resp_summary <- resp_exp_filtered %>%
  group_by(Treatment, Month) %>%
  dplyr::summarize(
    n = n(),  # Count observations per group
    mean_resp = mean(micromol.cm2.h, na.rm = TRUE),
    sd_resp = sd(micromol.cm2.h, na.rm = TRUE),
    sem_resp = sd_resp / sqrt(n),  # SEM formula
    .groups = "drop"
  )
```

Obtain significance letters 
```{r}
# Extract the p.adjust values and names of comparisons
pvals <- tukey_result$Timepoint[, "p adj"]

# Set names for pvals as "TP1-TP0" etc. (they are already named like that in the TukeyHSD output)
names(pvals) <- rownames(tukey_result$Timepoint)

# Generate letters for significance groups
sig_letters <- multcompLetters(pvals, threshold = 0.05)

# View assigned letters for each timepoint
print(sig_letters$Letters)
```

Add letters for plotting 
```{r}
month_letters_manual <- tibble::tibble(
  Month = c("February", "March", "Early April", "Late April", "May", "June", "July", "August"),
  Letters = c("abcd", "a", "abc", "abcd", "ab", "bcd", "d", "cd"),
  y_position = c(1.45, 1.48, 1, 0.88, 1.8, -0.18, -0.4, -0.21) # 0.2 offset from highest sd 
)
```

Plot as dot and whisker plots
```{r}
# Set Month as factor 
resp_summary$Month <- factor(resp_summary$Month, levels = c("February", "March", "Early April", "Late April", "May", "June", "July", "August"))

# sem
resp_dot_sem <- ggplot(resp_summary, aes(x = Month, y = mean_resp, color = Treatment)) +
  geom_line(aes(group = Treatment), linewidth = 1.5) +  # Connection lines
  geom_errorbar(aes(ymin = mean_resp - sem_resp, 
                    ymax = mean_resp + sem_resp), 
                width = 0.2) +
  geom_point(size = 5, aes(fill = Treatment), shape = 21, color = "black") +
  geom_text(data = month_letters_manual,
            aes(x = Month, y = y_position, label = Letters),
            inherit.aes = FALSE,
            position = position_dodge(width = 0.5),
            size = 10) +
  xlab("") +
  ylab(expression(bold('Respiration ('*mu~ 'mol' ~cm^-2*~ h^-1*')'))) +
  scale_color_manual(values = c("Acclimation" = "grey60", 
                               "Ambient" = "#377EB8",  # Blue
                               "Heat" = "#E41A1C")) +  # Red
  scale_fill_manual(values = c("Acclimation" = "grey80", 
                              "Ambient" = "#377EB8", 
                              "Heat" = "#E41A1C")) +
  theme_classic(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "top"); resp_dot_sem
ggsave("../output/Physiology/PR/Respiration_Treatment_Timepoin_dotwhisker_sem.pdf", resp_dot_sem, width = 20, height = 15)
ggsave("../output/Physiology/PR/Respiration_Treatment_Timepoin_dotwhisker_sem.png", resp_dot_sem, width = 20, height = 15)

# sd
resp_dot_sd <- ggplot(resp_summary, aes(x = Month, y = mean_resp, color = Treatment)) +
  geom_hline(yintercept = 0, color = "black", linetype = "dotted", linewidth = 1)+
  geom_line(aes(group = Treatment), linewidth = 4) +
  geom_errorbar(aes(ymin = mean_resp - sd_resp, 
                    ymax = mean_resp + sd_resp),
                linewidth = 2,  # Thicker error bars
                width = 0.5) +
  geom_point(size = 10, aes(fill = Treatment), 
             shape = 21, color = "black", stroke = 2) +  # Thicker point borders
  geom_text(data = month_letters_manual,
            aes(x = Month, y = y_position, label = Letters),
            inherit.aes = FALSE,
            position = position_dodge(width = 0.5),
            size = 10) +
  scale_color_manual(values = c("Acclimation" = "grey60", 
                               "Ambient" = "#377EB8",
                               "Heat" = "#E41A1C")) +
  scale_fill_manual(values = c("Acclimation" = "grey80", 
                              "Ambient" = "#377EB8", 
                              "Heat" = "#E41A1C")) +
  xlab("") +
  ylab(expression(bold('Respiration ('*mu~ 'mol' ~cm^-2*~ h^-1*')'))) +
  theme_classic() +  # Increased base font size
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 30, face = "bold", color = "black"),
    axis.text.y = element_text(size = 30, face = "bold", color = "black"),
    axis.title.y = element_text(size = 40, margin = margin(r = 15)),
    axis.ticks.x = element_line(size = 1, color = "black"),
    axis.ticks.length = unit(0.3, "cm"),
    legend.title = element_text(size = 35, face = "bold"),
    legend.text = element_text(size = 25),
    legend.position = "top",
    legend.key.size = unit(1.5, "cm"),
    legend.spacing.y = unit(0.5, "cm")
  );resp_dot_sd
ggsave("../output/Physiology/PR/Respiration_Treatment_Timepoin_dotwhisker_sd.pdf", resp_dot_sd, width = 22, height = 12)
ggsave("../output/Physiology/PR/Respiration_Treatment_Timepoin_dotwhisker_sd.png", resp_dot_sd, width = 22, height = 12)

```

# Remove February and rerun stats

## Photosynthesis 

Read in data
```{r}
exp <- read_csv(file = "../output/Physiology/PR/PR_rates.csv")

photo_exp <- exp %>%
  filter(Light_Value > 0)
```

Set dates as timepoints
```{r}
photo_exp <- photo_exp %>%
  mutate(Timepoint = case_when(
    Date == "2021-02-04" ~ "TP0",
    Date == "2021-03-04" ~ "TP1",
    Date == "2021-04-01" ~ "TP2",
    Date == "2021-04-29" ~ "TP3",
    Date == "2021-05-27" ~ "TP4",
    Date == "2021-06-24" ~ "TP5",
    Date == "2021-07-22" ~ "TP6",
    Date == "2021-08-19" ~ "TP7")) %>%
  filter(!Timepoint == "TP0")
```

Check for outliers
```{r}
# Look for outliers visually
ggplot(photo_exp, aes(x = Treatment, y = micromol.cm2.h)) + 
  geom_boxplot(outlier.color = "red", outlier.shape = 16) +
  theme_minimal()

# IQR method 
Q1 <- quantile(photo_exp$micromol.cm2.h, 0.25)
Q3 <- quantile(photo_exp$micromol.cm2.h, 0.75)
IQR_val <- Q3 - Q1

lower_bound <- Q1 - 1.5 * IQR_val
upper_bound <- Q3 + 1.5 * IQR_val
outliers <- photo_exp[photo_exp$micromol.cm2.h < lower_bound | photo_exp$micromol.cm2.h > upper_bound, ]
print(outliers)

# Z-score method
photo_exp$z_score <- scale(photo_exp$micromol.cm2.h)
outliers_z <- photo_exp[abs(photo_exp$z_score) > 3, ]
print(outliers_z)
```

Remove outliers based on IQR
```{r}
# Calculate IQR
Q1 <- quantile(photo_exp$micromol.cm2.h, 0.25)
Q3 <- quantile(photo_exp$micromol.cm2.h, 0.75)
IQR_val <- Q3 - Q1

lower_bound <- Q1 - 1.5 * IQR_val
upper_bound <- Q3 + 1.5 * IQR_val

# Filter dataset to remove outliers
photo_exp_filtered <- photo_exp[photo_exp$micromol.cm2.h >= lower_bound & photo_exp$micromol.cm2.h <= upper_bound, ]

# Check dimensions before and after
dim(photo_exp)
dim(photo_exp_filtered)
```

15 outliers removed. 

Assess normality of data 
```{r}
# Histogram
ggplot(photo_exp_filtered, aes(x = micromol.cm2.h)) + 
  geom_histogram(bins = 30, fill = "skyblue", color = "black") + 
  theme_minimal()

# Q-Q Plot
qqnorm(photo_exp_filtered$micromol.cm2.h)
qqline(photo_exp_filtered$micromol.cm2.h, col = "red")

# Shapiro-Wilk Test
shapiro.test(photo_exp_filtered$micromol.cm2.h)
```

Data is normal. Run a two-way ANOVA. 
```{r}
# Ensure factors are properly set
photo_exp_filtered$Treatment <- as.factor(photo_exp_filtered$Treatment)
photo_exp_filtered$Timepoint <- as.factor(photo_exp_filtered$Timepoint)

# Run two-way ANOVA
anova_result <- aov(micromol.cm2.h ~ Treatment * Timepoint, data = photo_exp_filtered)
summary(anova_result)

# Check for homogenity of variance 
leveneTest(micromol.cm2.h ~ Treatment * Timepoint, data = photo_exp_filtered)

# Check residuals 
# Residuals vs Fitted Plot (Check homoscedasticity)
plot(anova_result, which = 1)

# Q-Q Plot of Residuals (Check normality)
plot(anova_result, which = 2)
```

Timepoint and the interaction are significant, but treatment is not 

Run post-hoc tests
```{r}
TukeyHSD(anova_result, "Timepoint", conf.level = 0.95)
plot(TukeyHSD(anova_result, conf.level=.95), las = 2)

# Create interaction factor and run post hoc test
photo_exp_filtered$TrtTime <- interaction(photo_exp_filtered$Treatment, photo_exp_filtered$Timepoint)
anova_result2 <- aov(micromol.cm2.h ~ TrtTime, data = photo_exp_filtered)
TukeyHSD(anova_result2, "TrtTime")
```

Assign month to TPs
```{r}
photo_exp_filtered <- photo_exp_filtered %>% 
  mutate(Month = case_when(
    Timepoint == "TP1" ~ "March", 
    Timepoint == "TP2" ~ "Early April", 
    Timepoint == "TP3" ~ "Late April", 
    Timepoint == "TP4" ~ "May", 
    Timepoint == "TP5" ~ "June", 
    Timepoint == "TP6" ~ "July", 
    Timepoint == "TP7" ~ "August")) 
```

Calculate mean, sd and sem of each group for plotting 
```{r}
photo_summary <- photo_exp_filtered %>%
  group_by(Treatment, Month) %>%
  dplyr::summarize(
    n = n(),  # Count observations per group
    mean_photo = mean(micromol.cm2.h, na.rm = TRUE),
    sd_photo = sd(micromol.cm2.h, na.rm = TRUE),
    sem_photo = micromol.cm2.h / sqrt(n),  # SEM formula
    .groups = "drop"
  )
```

Plot as dot and whisker plots
```{r}
# Set Month as factor 
photo_summary$Month <- factor(photo_summary$Month, levels = c("February", "March", "Early April", "Late April", "May", "June", "July", "August"))

# sem
photo_dot_sem <- ggplot(photo_summary, aes(x = Month, y = mean_photo, color = Treatment)) +
  geom_line(aes(group = Treatment), linewidth = 1.5) +  # Connection lines
  geom_errorbar(aes(ymin = mean_photo - sem_photo, 
                    ymax = mean_photo + sem_photo), 
                width = 0.2) +
  geom_point(size = 5, aes(fill = Treatment), shape = 21, color = "black") +
  xlab("") +
  ylab(expression(bold('Net Photosynthesis ('*mu~ 'mol' ~cm^-2*~ h^-1*')'))) +
  scale_color_manual(values = c("Acclimation" = "grey60", 
                               "Ambient" = "#377EB8",  # Blue
                               "Heat" = "#E41A1C")) +  # Red
  scale_fill_manual(values = c("Acclimation" = "grey80", 
                              "Ambient" = "#377EB8", 
                              "Heat" = "#E41A1C")) +
  theme_classic(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right"); photo_dot_sem
ggsave("../output/Physiology/PR/NetPhoto_Treatment_Timepoin_dotwhisker_sem_noFeb.pdf", photo_dot_sem, width = 20, height = 15)
ggsave("../output/Physiology/PR/NetPhoto_Treatment_Timepoin_dotwhisker_sem_noFeb.png", photo_dot_sem, width = 20, height = 15)

# sd
photo_dot_sd <- ggplot(photo_summary, aes(x = Month, y = mean_photo, color = Treatment)) +
  geom_hline(yintercept = 0, color = "black", linetype = "dotted", linewidth = 1)+
  geom_line(aes(group = Treatment), linewidth = 4) +
  geom_errorbar(aes(ymin = mean_photo - sd_photo, 
                    ymax = mean_photo + sd_photo),
                linewidth = 2,  # Thicker error bars
                width = 0.5) +
  geom_point(size = 10, aes(fill = Treatment), 
             shape = 21, color = "black", stroke = 2) +  # Thicker point borders
  scale_color_manual(values = c("Acclimation" = "grey60", 
                               "Ambient" = "#377EB8",
                               "Heat" = "#E41A1C")) +
  scale_fill_manual(values = c("Acclimation" = "grey80", 
                              "Ambient" = "#377EB8", 
                              "Heat" = "#E41A1C")) +
  xlab("") +
  ylab(expression(bold('Net Photosynthesis ('*mu~ 'mol' ~cm^-2*~ h^-1*')'))) +
  theme_classic() +  # Increased base font size
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 30, face = "bold", color = "black"),
    axis.text.y = element_text(size = 30, face = "bold", color = "black"),
    axis.title.y = element_text(size = 40, margin = margin(r = 15)),
    axis.ticks.x = element_line(size = 1, color = "black"),
    axis.ticks.length = unit(0.3, "cm"),
    legend.title = element_text(size = 35, face = "bold"),
    legend.text = element_text(size = 25),
    legend.key.size = unit(1.5, "cm"),
    legend.spacing.y = unit(0.5, "cm")
  );photo_dot_sd
ggsave("../output/Physiology/PR/NetPhoto_Treatment_Timepoin_dotwhisker_sd_noFeb.pdf", photo_dot_sd, width = 22, height = 12)
ggsave("../output/Physiology/PR/NetPhoto_Treatment_Timepoin_dotwhisker_sd_noFeb.png", photo_dot_sd, width = 22, height = 12)
```

## Respiration 

Read in data
```{r}
exp <- read_csv(file = "../output/Physiology/PR/PR_rates.csv")

resp_exp <- exp %>%
  filter(Light_Value == 0)
```

Set dates as timepoints
```{r}
resp_exp <- resp_exp %>%
  mutate(Timepoint = case_when(
    Date == "2021-02-04" ~ "TP0",
    Date == "2021-03-04" ~ "TP1",
    Date == "2021-04-01" ~ "TP2",
    Date == "2021-04-29" ~ "TP3",
    Date == "2021-05-27" ~ "TP4",
    Date == "2021-06-24" ~ "TP5",
    Date == "2021-07-22" ~ "TP6",
    Date == "2021-08-19" ~ "TP7")) %>%
  filter(!Timepoint == "TP0")
```

Check for outliers
```{r}
# Look for outliers visually
ggplot(resp_exp, aes(x = Treatment, y = micromol.cm2.h)) + 
  geom_boxplot(outlier.color = "red", outlier.shape = 16) +
  theme_minimal()

# IQR method 
Q1 <- quantile(resp_exp$micromol.cm2.h, 0.25)
Q3 <- quantile(resp_exp$micromol.cm2.h, 0.75)
IQR_val <- Q3 - Q1

lower_bound <- Q1 - 1.5 * IQR_val
upper_bound <- Q3 + 1.5 * IQR_val
outliers <- resp_exp[resp_exp$micromol.cm2.h < lower_bound | resp_exp$micromol.cm2.h > upper_bound, ]
print(outliers)

# Z-score method
resp_exp$z_score <- scale(resp_exp$micromol.cm2.h)
outliers_z <- resp_exp[abs(resp_exp$z_score) > 3, ]
print(outliers_z)
```

Remove outliers based on IQR
```{r}
# Calculate IQR
Q1 <- quantile(resp_exp$micromol.cm2.h, 0.25)
Q3 <- quantile(resp_exp$micromol.cm2.h, 0.75)
IQR_val <- Q3 - Q1

lower_bound <- Q1 - 1.5 * IQR_val
upper_bound <- Q3 + 1.5 * IQR_val

# Filter dataset to remove outliers
resp_exp_filtered <- resp_exp[resp_exp$micromol.cm2.h >= lower_bound & resp_exp$micromol.cm2.h <= upper_bound, ]

# Check dimensions before and after
dim(resp_exp)
dim(resp_exp_filtered)
```

12 outliers removed 

Assess normality of data 
```{r}
# Histogram
ggplot(resp_exp_filtered, aes(x = micromol.cm2.h)) + 
  geom_histogram(bins = 30, fill = "skyblue", color = "black") + 
  theme_minimal()

# Q-Q Plot
qqnorm(resp_exp_filtered$micromol.cm2.h)
qqline(resp_exp_filtered$micromol.cm2.h, col = "red")

# Shapiro-Wilk Test
shapiro.test(resp_exp_filtered$micromol.cm2.h)
```

Run a two-way ANOVA
```{r}
# Ensure factors are properly set
resp_exp_filtered$Treatment <- as.factor(resp_exp_filtered$Treatment)
resp_exp_filtered$Timepoint <- as.factor(resp_exp_filtered$Timepoint)

# Run two-way ANOVA
anova_result <- aov(micromol.cm2.h ~ Treatment * Timepoint, data = resp_exp_filtered)
summary(anova_result)

# Check for homogenity of variance 
leveneTest(micromol.cm2.h ~ Treatment * Timepoint, data = resp_exp_filtered)

# Check residuals 
# Residuals vs Fitted Plot (Check homoscedasticity)
plot(anova_result, which = 1)

# Q-Q Plot of Residuals (Check normality)
plot(anova_result, which = 2)
```

Timepoint and the interaction are significant, but treatment is not 

Run post-hoc tests
```{r}
TukeyHSD(anova_result, "Timepoint", conf.level = 0.95)
plot(TukeyHSD(anova_result, conf.level=.95), las = 2)

# Create interaction factor and run post hoc test
resp_exp_filtered$TrtTime <- interaction(resp_exp_filtered$Treatment, resp_exp_filtered$Timepoint)
anova_result2 <- aov(micromol.cm2.h ~ TrtTime, data = resp_exp_filtered)
TukeyHSD(anova_result2, "TrtTime")
```

Assign month to TPs
```{r}
resp_exp_filtered <- resp_exp_filtered %>% 
  mutate(Month = case_when(
    Timepoint == "TP1" ~ "March", 
    Timepoint == "TP2" ~ "Early April", 
    Timepoint == "TP3" ~ "Late April", 
    Timepoint == "TP4" ~ "May", 
    Timepoint == "TP5" ~ "June", 
    Timepoint == "TP6" ~ "July", 
    Timepoint == "TP7" ~ "August")) 
```

Calculate mean, sd and sem of each group for plotting 
```{r}
resp_summary <- resp_exp_filtered %>%
  group_by(Treatment, Month) %>%
  dplyr::summarize(
    n = n(),  # Count observations per group
    mean_resp = mean(micromol.cm2.h, na.rm = TRUE),
    sd_resp = sd(micromol.cm2.h, na.rm = TRUE),
    sem_resp = micromol.cm2.h / sqrt(n),  # SEM formula
    .groups = "drop"
  )
```

Plot as dot and whisker plots
```{r}
# Set Month as factor 
resp_summary$Month <- factor(resp_summary$Month, levels = c("March", "Early April", "Late April", "May", "June", "July", "August"))

# sem
resp_dot_sem <- ggplot(resp_summary, aes(x = Month, y = mean_resp, color = Treatment)) +
  geom_line(aes(group = Treatment), linewidth = 1.5) +  # Connection lines
  geom_errorbar(aes(ymin = mean_resp - sem_resp, 
                    ymax = mean_resp + sem_resp), 
                width = 0.2) +
  geom_point(size = 5, aes(fill = Treatment), shape = 21, color = "black") +
  xlab("") +
  ylab(expression(bold('Respiration ('*mu~ 'mol' ~cm^-2*~ h^-1*')'))) +
  scale_color_manual(values = c("Acclimation" = "grey60", 
                               "Ambient" = "#377EB8",  # Blue
                               "Heat" = "#E41A1C")) +  # Red
  scale_fill_manual(values = c("Acclimation" = "grey80", 
                              "Ambient" = "#377EB8", 
                              "Heat" = "#E41A1C")) +
  theme_classic(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right"); resp_dot_sem
ggsave("../output/Physiology/PR/Respiration_Treatment_Timepoin_dotwhisker_sem_noFeb.pdf", resp_dot_sem, width = 20, height = 15)
ggsave("../output/Physiology/PR/Respiration_Treatment_Timepoin_dotwhisker_sem_noFeb.png", resp_dot_sem, width = 20, height = 15)

# sd
resp_dot_sd <- ggplot(resp_summary, aes(x = Month, y = mean_resp, color = Treatment)) +
  geom_hline(yintercept = 0, color = "black", linetype = "dotted", linewidth = 1)+
  geom_line(aes(group = Treatment), linewidth = 4) +
  geom_errorbar(aes(ymin = mean_resp - sd_resp, 
                    ymax = mean_resp + sd_resp),
                linewidth = 2,  # Thicker error bars
                width = 0.5) +
  geom_point(size = 10, aes(fill = Treatment), 
             shape = 21, color = "black", stroke = 2) +  # Thicker point borders
  scale_color_manual(values = c("Acclimation" = "grey60", 
                               "Ambient" = "#377EB8",
                               "Heat" = "#E41A1C")) +
  scale_fill_manual(values = c("Acclimation" = "grey80", 
                              "Ambient" = "#377EB8", 
                              "Heat" = "#E41A1C")) +
  xlab("") +
  ylab(expression(bold('Respiration ('*mu~ 'mol' ~cm^-2*~ h^-1*')'))) +
  theme_classic() +  # Increased base font size
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 30, face = "bold", color = "black"),
    axis.text.y = element_text(size = 30, face = "bold", color = "black"),
    axis.title.y = element_text(size = 40, margin = margin(r = 15)),
    axis.ticks.x = element_line(size = 1, color = "black"),
    axis.ticks.length = unit(0.3, "cm"),
    legend.title = element_text(size = 35, face = "bold"),
    legend.text = element_text(size = 25),
    legend.key.size = unit(1.5, "cm"),
    legend.spacing.y = unit(0.5, "cm")
  );resp_dot_sd
ggsave("../output/Physiology/PR/Respiration_Treatment_Timepoin_dotwhisker_sd_noFeb.pdf", resp_dot_sd, width = 22, height = 12)
ggsave("../output/Physiology/PR/Respiration_Treatment_Timepoin_dotwhisker_sd_noFeb.png", resp_dot_sd, width = 22, height = 12)
```

