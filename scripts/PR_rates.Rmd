---
title: "Photosynthesis and respiration rate calculations"
output: html_document
---

# PR data from experimental corals

Updated R/RStudio and packages are loading weirdly. Going to try to reinstall 
```{r}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("devtools")
BiocManager::install("furr")
BiocManager::install("future")
BiocManager::install("tidyverse", force = TRUE)
BiocManager::install("gridExtra")
BiocManager::install("ggpubr")
BiocManager::install("lubridate")
BiocManager::install("cowplot")
BiocManager::install("LoLinR")
#BiocManager::install("dplyr", force = TRUE)
```


## load packages
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

## install packages if you dont already have them in your library
if (!require("devtools")) install.packages("devtools")
if (!require("furrr")) install.packages("furrr")
if (!require("future")) install.packages("future")
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("gridExtra")) install.packages("gridExtra")
if (!require("ggpubr")) install.packages("ggpubr")
if (!require("lubridate")) install.packages("lubridate")
if (!require("cowplot")) install.packages("cowplot")
if (!require("LoLinR")) install_github('colin-olito/LoLinR') 

## load libraries
library(devtools)
library(LoLinR)
library(tidyverse)
library(gridExtra)
library(ggpubr)
library(lubridate)
library(cowplot)
#library(dplyr)

## libraries for parallel processing
library(future)
library(furrr)
```

## Set working directory 
```{r}
#setwd('/Users/jillashey/Desktop/PutnamLab/Repositories/Astrangia_repo/Astrangia_repo/')

#Warning: The working directory was changed to /Users/jillashey/Desktop/PutnamLab/Repositories/Astrangia_repo/Astrangia_repo inside a notebook chunk. The working directory will be reset when the chunk is finished running. Use the knitr root.dir option in the setup chunk to change the working directory for notebook chunks.
## working directory is being weird 
```


## Import data
```{r}
path.p <- "data/Physiology/PR/raw" #the location of all your respirometry files 

# List data files
file.names <- list.files(path = path.p, pattern = "csv$")  # list all csv file names in the folder
file.names <- file.names[!grepl("metadata", file.names)]   # omit metadata from files to be read in as data

# Load PI curve sample metadata (i.e., which corals were in which runs)
sample.info <- read_csv("data/Physiology/PR/PR_sample_metadata.csv")

# Load PI curve run metadata (i.e., light levels and interval times for each run)
run.info <- read_csv(file = "data/Physiology/PR/PR_run_metadata.csv")

# Join all coral and run metadata
metadata <- full_join(sample.info, run.info) %>%
  mutate(Date = as_date(as.character(Date), format = "%Y%m%d", tz = "Tahiti"))

# Select only certain columnns
metadata <- metadata %>%
  select(colony_id, Run, Treatment,Chamber.Vol.L, Date, Start.time, Stop.time, Light_Value,Surface.Area.cm2)

# # Read in all data files
# df <- tibble(file.name = file.names) %>%
#   mutate(colony_id = gsub("_.*", "", file.name),                              # Get colony_id from filename
#           info = map(colony_id, ~filter(metadata, colony_id == .)),           # Get associated sample info
#          data0 = map(file.name, ~read_csv(file.path(path.p, .), skip = 1)))   # Get associated O2 data
# 
# # Select only Time, Value, and Temp columns from O2 data
# df <- df %>%
#   mutate(data0 = map(data0, ~select(., Time, Value, Temp))) %>% 
#   mutate(data0 = map(data0, ~(.x %>% filter(complete.cases(.))))) #remove NAs to get rid of artifact line in our data









df <- tibble(file.name = file.names) %>%
  mutate(colony_id = gsub("_.*", "", file.name),                              # Get colony_id from filename
          info = map(colony_id, ~filter(metadata, colony_id == .)),           # Get associated sample info
         data0 = map(file.name, ~read_csv(file.path(path.p, .), skip = 1, col_types = cols(.default = "d", Time = "t"))))   # Get associated O2 data
# Select only Time, Value, and Temp columns from O2 data
df <- df %>%
  mutate(data0 = map(data0, ~select(., Time, Value, Temp)))%>%
  mutate(data0 = map(data0, ~(.x %>% filter(complete.cases(.))))) #remove NAs to get rid of artifact line in our data
```

## Use the time breaks in the sample info to link O2 data with light levels
```{r}
# df <- df %>%
#   dplyr::mutate(intervals = map2(data0, info, function(.x, .y) {
#     split(.x, f = cut(as.numeric(.x$Time), breaks = as.numeric(c(.y$Start.time, last(.y$Stop.time))),
#                       labels = as.character(.y$Light_Value)))})) %>%
#   dplyr::mutate(data = map(intervals, ~ unnest(tibble(.), .id = "Light_Value")))
# 
# ## 'data' now contains the O2 data with the corresponding light level as another column
# ## Example of what 'data' for each sample looks like:
# #df$data[[1]]


df <- df %>%
  mutate(intervals = map2(data0, info, function(.x, .y) {
    split(.x, f = cut(as.numeric(.x$Time), breaks = as.numeric(c(.y$Start.time, last(.y$Stop.time))),
                      labels = as.character(.y$Light_Value)))})) %>%
  mutate(data = map(intervals, ~ unnest(tibble(.), .id = "Light_Value")))
```

### Thin data
```{r, fig.height = 8, fig.width = 8}
# Set thinning parameter
thin_par <- 20

# Thin data for all samples
df <- df %>%
  mutate(thin_data = map(data, ~ slice(., seq(1, nrow(.), thin_par))))

# Create plots for full dataset and thinned data
df <- df %>%
  mutate(data_plot = map2(data, colony_id, ~ ggplot(.x, aes(x = Time, y = Value)) + 
                            facet_wrap(~ as.numeric(Light_Value), scales = "free") +
                            geom_point() +
                            labs(title = .y)),
    thin_data_plot = map2(thin_data, colony_id, ~ ggplot(.x, aes(x = Time, y = Value)) + 
                            facet_wrap(~ as.numeric(Light_Value), scales = "free") +
                            geom_point() +
                            labs(title = .y)))

# Example of plots
cowplot::plot_grid(df$data_plot[[1]], df$thin_data_plot[[1]], nrow = 2,
                   labels = c("Example plot: all data", "Example plot: thinned data"))
```

#### The full or thinned data plot for any sample can be accessed like this:
```{r}
df %>%
  filter(colony_id == "AST-1109") %>%
  pull(thin_data_plot)
```

# Fit regressions to each interval for each sample
```{r}
# Define function for fitting LoLinR regressions to be applied to all intervals for all samples
fit_reg <- function(df) {
  rankLocReg(xall = as.numeric(df$Time), yall = df$Value, 
             alpha = 0.2, method = "pc", verbose = FALSE)
}

# Setup for parallel processing
future::plan()

# Map LoLinR function onto all intervals of each sample's thinned dataset
df <- df %>%
  mutate(regs = furrr::future_map(thin_data, function(.) {       # future_map executes function in parallel
    group_by(., Light_Value) %>%
    do(rankLcRg = fit_reg(.))
  }))

## Now 'regs' contains the fitted local regressions for each interval of each sample's thinned dataset

# Define function to pull out and plot regression diagnostics
plot_rankLcRg <- function(colony_id, interval_number) {
  df %>%
    filter(colony_id == colony_id) %>%
    pluck("regs", 1, "rankLcRg", interval_number) %>%
    plot()
}
```

#### The diagnostics for any regression can be plotted like this, specifying a colony_id and the number of the light curve interval:
```{r}
plot_rankLcRg("AST-1343", 1) 
```

### Extract slope of best regression for each interval for each sample
```{r}
df.out <- df %>% 
  unnest(regs) %>%
  mutate(micromol.L.s = map_dbl(rankLcRg, ~ pluck(., "allRegs", "b1", 1)))
```

# Adjust by chamber volume and normalize to surface area
```{r}
### Merge rates with sample info
pr <- left_join(
  select(df.out, colony_id, Light_Value, micromol.L.s),
  distinct(metadata, colony_id, Run, Treatment,Chamber.Vol.L, Surface.Area.cm2, Date)
)

### Correct for chamber volume and blanks
pr <- pr %>%
  mutate(micromol.s = micromol.L.s * Chamber.Vol.L)

# Get blank values -- average for each run and light value in case multiple blanks
blanks <- pr %>%
  filter(grepl("BK", colony_id)) %>%
  group_by(Run, Light_Value) %>%
  summarise(micromol.s.blank = mean(micromol.s))

# Join blank values with rest of data and subtract values from samples for same run and light value
pr <- left_join(pr, blanks) %>%
  mutate(micromol.s.adj = micromol.s - micromol.s.blank) %>%
  # After correcting for blank values, remove blanks from data
  filter(!grepl("BK", colony_id))


# Normalize rates by surface area
pr <- pr %>%
  mutate(micromol.cm2.s = micromol.s.adj / Surface.Area.cm2,
         micromol.cm2.h = micromol.cm2.s * 3600)
```

# Plot rates vs. irradiance for each sample
```{r, fig.height=2, fig.width = 8}
ggplot(pr, aes(x = as.numeric(Light_Value), y = micromol.cm2.h)) +
  geom_point() +
  facet_wrap(~colony_id*Light_Value, ncol = 9)
```

# Write to output file
```{r}
# Select variables to write to file
pr.out <- pr %>% select(colony_id, Light_Value, Run,Treatment, micromol.cm2.s, micromol.cm2.h, Date)

# Write to output file
write.csv(pr.out, "output/Physiology/PR/PR_rates.csv")
```

```{r}
pr.save <- pr.out %>% select(colony_id, Light_Value, Run, Treatment, micromol.cm2.s, micromol.cm2.h, Date)

gd <- pr.save %>% group_by(Light_Value) %>% 
        summarise(avg = mean(micromol.cm2.h),
          sem = sd(micromol.cm2.h))

pr.save <- pr.save %>% 
  mutate(Timepoint = case_when(
    Date == "2021-02-04" ~ "TP0",
    Date == "2021-03-04" ~ "TP1",
    Date == "2021-04-01" ~ "TP2",
    Date == "2021-04-29" ~ "TP3",
    Date == "2021-05-27" ~ "TP4",
    Date == "2021-06-24" ~ "TP5", 
    Date == "2021-07-22" ~ "TP6",
    Date == "2021-08-19" ~ "TP7"))


pr.save <- pr.save %>% 
  mutate(Assay = case_when(
    Light_Value == "0" ~ "Rd",
    Light_Value == "320" ~ "P",
    Light_Value == "350" ~ "P",
    Light_Value == "368" ~ "P",
    Light_Value == "337" ~ "P",
    Light_Value == "355" ~ "P",
    Light_Value == "361" ~ "P", 
    Light_Value == "334" ~ "P",
    Light_Value == "358" ~ "P"))

gd <- pr.save %>% 
        group_by(Assay,Timepoint,Treatment) %>% 
        summarise(avg = mean(micromol.cm2.h),
                  sem  = sd(micromol.cm2.h)/sqrt(length((micromol.cm2.h))))

trt.plot <- ggplot(pr.save, aes(x = Timepoint, y = micromol.cm2.h, group=Treatment)) +
   geom_point(alpha = .4, aes(colour = Treatment), size = 2) +
    geom_point(data = gd, aes(x = Timepoint, y = avg, group=Treatment, colour = Treatment), size=4)+
    scale_color_manual(values=c('black','blue', 'red'))+
    #geom_errorbar(data = gd, aes(ymin=avg-sem, ymax=avg+sem)) +
  geom_point(data = gd, aes(x = Timepoint, y = avg-sem, group=Treatment, colour = Treatment), size=2, shape=8)+
  geom_point(data = gd, aes(x = Timepoint, y = avg+sem, group=Treatment, colour = Treatment), size=2, shape=8)+
   geom_line(data = gd, aes(x = Timepoint, y = avg, group=Treatment, colour = Treatment)) +
   #ylim(-0.4,0.5) +
  facet_wrap(~Assay, ncol = 2)+
   theme_bw()+
  theme(legend.position = c(0.63, 0.8),
        legend.title = element_text(colour="black", size=6, 
                                     face="bold"),
        legend.text = element_text(size=4))+
  theme(text = element_text(size=15),
        axis.text.x = element_text(angle=90, hjust=1)) +
  guides(color = guide_legend(override.aes = list(size = 1)))
trt.plot

plot <- grid.arrange(trt.plot, clip="off")
ggsave("output/Physiology/PR/Timepoint.Treatment_PR.pdf", plot, width = 6, height = 5, units = c("in"))


# # Individual plots for each sample 
# indiv = ggplot(pr.save, aes(x = as.numeric(Light_Value), y = micromol.cm2.h)) +
#    geom_point(alpha = .4, aes(colour = Treatment)) +
#    ylim(-0.3,0.5)+
#    #geom_point(data = gd, size = 4) +
#    theme_bw() +
#    facet_wrap(~colony_id, ncol = 3)
# ggsave("../output/PR/IndividualSample_PR.pdf", indiv, width = 21, height = 21, units = c("in"))
# 
# 
# p2 = ggplot(pr.save, aes(x = Timepoint, y = micromol.cm2.h)) +
#    geom_point(alpha = .4, aes(colour = Treatment, shape = Light_Value), size = 4) +
#    ylim(-0.3,0.5) +
#    #geom_point(data = gd, size = 4) +
#    theme_bw()
# p2 + scale_color_manual(values = c("black", "blue", "red"))
```




#################### PR data from field corals #################### 
## Import data
```{r}
path.p <- "data/Physiology/PR/raw_field" #the location of all your respirometry files 

# List data files
file.names <- list.files(path = path.p, pattern = "csv$")  # list all csv file names in the folder
file.names <- file.names[!grepl("metadata", file.names)]   # omit metadata from files to be read in as data

# Load PI curve sample metadata (i.e., which corals were in which runs)
sample.info <- read_csv(file = "data/Physiology/PR/PR_field_sample_metadata.csv")

# Load PI curve run metadata (i.e., light levels and interval times for each run)
run.info <- read_csv(file = "data/Physiology/PR/PR_field_run_metadata.csv")

# Join all coral and run metadata
metadata <- full_join(sample.info, run.info) %>%
  mutate(Date = as_date(as.character(Date), format = "%Y%m%d", tz = "Tahiti"))

# Select only certain columnns
metadata <- metadata %>%
  select(colony_id, Run, Treatment,Chamber.Vol.L, Date, Start.time, Stop.time, Light_Value,Surface.Area.cm2)

# Read in all data
df <- tibble(file.name = file.names) %>%
  mutate(colony_id = gsub("_.*", "", file.name),                              # Get colony_id from filename
          info = map(colony_id, ~filter(metadata, colony_id == .)),           # Get associated sample info
         data0 = map(file.name, ~read_csv(file.path(path.p, .), skip = 1, col_types = cols(.default = "d", Time = "t"))))   # Get associated O2 data

# Select only Time, Value, and Temp columns from O2 data
df <- df %>%
  mutate(data0 = map(data0, ~select(., Time, Value, Temp)))%>%
  mutate(data0 = map(data0, ~(.x %>% filter(complete.cases(.))))) #remove NAs to get rid of artifact line in our data 
```


## Use the time breaks in the sample info to link O2 data with light levels
```{r, warning = FALSE}
df <- df %>%
  mutate(intervals = map2(data0, info, function(.x, .y) {
    split(.x, f = cut(as.numeric(.x$Time), breaks = as.numeric(c(.y$Start.time, last(.y$Stop.time))),
                      labels = as.character(.y$Light_Value)))})) %>%
  mutate(data = map(intervals, ~ unnest(tibble(.), .id = "Light_Value")))

## 'data' now contains the O2 data with the corresponding light level as another column
## Example of what 'data' for each sample looks like:
# df$data[[1]]
```

### Thin data
```{r, fig.height = 8, fig.width = 8}
# Set thinning parameter
thin_par <- 20

# Thin data for all samples
df <- df %>%
  mutate(thin_data = map(data, ~ slice(., seq(1, nrow(.), thin_par))))

# Create plots for full dataset and thinned data
df <- df %>%
  mutate(data_plot = map2(data, colony_id, ~ ggplot(.x, aes(x = Time, y = Value)) + 
                            facet_wrap(~ as.numeric(Light_Value), scales = "free") +
                            geom_point() +
                            labs(title = .y)),
    thin_data_plot = map2(thin_data, colony_id, ~ ggplot(.x, aes(x = Time, y = Value)) + 
                            facet_wrap(~ as.numeric(Light_Value), scales = "free") +
                            geom_point() +
                            labs(title = .y)))

# Example of plots
cowplot::plot_grid(df$data_plot[[1]], df$thin_data_plot[[1]], nrow = 2,
                   labels = c("Example plot: all data", "Example plot: thinned data"))
```

#### The full or thinned data plot for any sample can be accessed like this:
```{r}
df %>%
  filter(colony_id == "FLD-0015") %>%
  pull(thin_data_plot)
```

# Fit regressions to each interval for each sample
```{r}
# Define function for fitting LoLinR regressions to be applied to all intervals for all samples
fit_reg <- function(df) {
  rankLocReg(xall = as.numeric(df$Time), yall = df$Value, 
             alpha = 0.2, method = "pc", verbose = FALSE)
}

# Setup for parallel processing
future::plan()

# Map LoLinR function onto all intervals of each sample's thinned dataset
df <- df %>%
  mutate(regs = furrr::future_map(thin_data, function(.) {       # future_map executes function in parallel
    group_by(., Light_Value) %>%
    do(rankLcRg = fit_reg(.))
  }))

## Now 'regs' contains the fitted local regressions for each interval of each sample's thinned dataset

# Define function to pull out and plot regression diagnostics
plot_rankLcRg <- function(colony_id, interval_number) {
  df %>%
    filter(colony_id == colony_id) %>%
    pluck("regs", 1, "rankLcRg", interval_number) %>%
    plot()
}
```

#### The diagnostics for any regression can be plotted like this, specifying a colony_id and the number of the light curve interval:
```{r}
plot_rankLcRg("FLD-0037", 1) 
```

### Extract slope of best regression for each interval for each sample
```{r}
df.out <- df %>% 
  unnest(regs) %>%
  mutate(micromol.L.s = map_dbl(rankLcRg, ~ pluck(., "allRegs", "b1", 1)))
```

# Adjust by chamber volume and normalize to surface area
```{r}
### Merge rates with sample info
pr <- left_join(
  select(df.out, colony_id, Light_Value, micromol.L.s),
  distinct(metadata, colony_id, Run, Treatment,Chamber.Vol.L, Surface.Area.cm2, Date)
)

### Correct for chamber volume and blanks
pr <- pr %>%
  mutate(micromol.s = micromol.L.s * Chamber.Vol.L)

# Get blank values -- average for each run and light value in case multiple blanks
blanks <- pr %>%
  filter(grepl("BK", colony_id)) %>%
  group_by(Run, Light_Value) %>%
  summarise(micromol.s.blank = mean(micromol.s))

# Join blank values with rest of data and subtract values from samples for same run and light value
pr <- left_join(pr, blanks) %>%
  mutate(micromol.s.adj = micromol.s - micromol.s.blank) %>%
  # After correcting for blank values, remove blanks from data
  filter(!grepl("BK", colony_id))

# Normalize rates by surface area
pr <- pr %>%
  mutate(micromol.cm2.s = micromol.s.adj / Surface.Area.cm2,
         micromol.cm2.h = micromol.cm2.s * 3600)
```

# Plot rates vs. irradiance for each sample
```{r, fig.height=2, fig.width = 8}
ggplot(pr, aes(x = as.numeric(Light_Value), y = micromol.cm2.h)) +
  geom_point() +
  facet_wrap(~colony_id*Light_Value, ncol = 9)
```

# Write to output file
```{r}
# Select variables to write to file
pr.out <- pr %>% select(colony_id, Light_Value, Run,Treatment, micromol.cm2.s, micromol.cm2.h, Date)

# Write to output file
write.csv(pr.out, "output/Physiology/PR/PR_field_rates.csv")
```

```{r}
pr.save <- pr.out %>% select(colony_id, Light_Value, Run, Treatment, micromol.cm2.s, micromol.cm2.h, Date)

gd <- pr.save %>% group_by(Light_Value) %>% 
        summarise(avg = mean(micromol.cm2.h),
          sem = sd(micromol.cm2.h))

pr.save <- pr.save %>% 
  mutate(Timepoint = case_when(
    Date == "2021-04-10" ~ "FLD-TP2",
    Date == "2021-04-30" ~ "FLD-TP3",
    Date == "2021-06-02" ~ "FLD-TP4",
    Date == "2021-06-25" ~ "FLD-TP5",
    Date == "2021-07-23" ~ "FLD-TP6",
    Date == "2021-09-01" ~ "FLD-TP7"))


pr.save <- pr.save %>% 
  mutate(Assay = case_when(
    Light_Value == "0" ~ "Rd",
    Light_Value == "340" ~ "P",
    Light_Value == "392" ~ "P",
    Light_Value == "321" ~ "P",
    Light_Value == "319" ~ "P",
    Light_Value == "366" ~ "P",
    Light_Value == "342" ~ "P"))

gd <- pr.save %>% 
        group_by(Assay,Timepoint,Treatment) %>% 
        summarise(avg = mean(micromol.cm2.h),
                  sem  = sd(micromol.cm2.h)/sqrt(length((micromol.cm2.h))))

field_trt.plot <- ggplot(pr.save, aes(x = Timepoint, y = micromol.cm2.h, group=Treatment)) +
   geom_point(alpha = .4, aes(colour = Treatment), size = 2) +
    geom_point(data = gd, aes(x = Timepoint, y = avg, group=Treatment, colour = Treatment), size=4)+
    #scale_color_manual(values=c('black','blue', 'red'))+
    #geom_errorbar(data = gd, aes(ymin=avg-sem, ymax=avg+sem)) +
  geom_point(data = gd, aes(x = Timepoint, y = avg-sem, group=Treatment, colour = Treatment), size=2, shape=8)+
  geom_point(data = gd, aes(x = Timepoint, y = avg+sem, group=Treatment, colour = Treatment), size=2, shape=8)+
   geom_line(data = gd, aes(x = Timepoint, y = avg, group=Treatment, colour = Treatment)) +
   #ylim(-0.4,0.5) +
  facet_wrap(~Assay, ncol = 2)+
   theme_bw()+
  theme(legend.position = c(0.63, 0.8),
        legend.title = element_text(colour="black", size=6, 
                                     face="bold"),
        legend.text = element_text(size=4))+
  guides(color = guide_legend(override.aes = list(size = 1)))
field_trt.plot

plot <- grid.arrange(field_trt.plot, clip="off")
ggsave("output/Physiology/PR/Field_Timepoint.Treatment_PR.pdf", plot, width = 4, height = 3.5, units = c("in"))


# # Individual plots for each sample 
# indiv = ggplot(pr.save, aes(x = as.numeric(Light_Value), y = micromol.cm2.h)) +
#    geom_point(alpha = .4, aes(colour = Treatment)) +
#    ylim(-0.3,0.5)+
#    #geom_point(data = gd, size = 4) +
#    theme_bw() +
#    facet_wrap(~colony_id, ncol = 3)
# ggsave("../output/PR/IndividualSample_PR.pdf", indiv, width = 21, height = 21, units = c("in"))
# 
# 
# p2 = ggplot(pr.save, aes(x = Timepoint, y = micromol.cm2.h)) +
#    geom_point(alpha = .4, aes(colour = Treatment, shape = Light_Value), size = 4) +
#    ylim(-0.3,0.5) +
#    #geom_point(data = gd, size = 4) +
#    theme_bw()
# p2 + scale_color_manual(values = c("black", "blue", "red"))
```


## Bind experimental and field plots 
```{r}
figure <- ggarrange(trt.plot, field_trt.plot,
                    #labels = c("A", "B", "C"),
                    ncol = 1, nrow = 2)
figure

plot <- grid.arrange(figure, clip="off")
ggsave("output/Physiology/PR/Combination.Exp.Fld_Timepoint.Treatment_PR.pdf", plot, width = 4, height = 7, units = c("in"))

```


## Plot experimental and field data in one plot 

### Import data 
```{r}
exp <- read_csv(file = "output/Physiology/PR/PR_rates.csv")
field <- read_csv(file = "output/Physiology/PR/PR_field_rates.csv")
field$Treatment <- "Field"


all <- full_join(exp, field) %>%
  as_tibble()
  
all <- all %>% 
  mutate(Timepoint = case_when(
    Date == "2021-02-04" ~ "TP0",
    Date == "2021-03-04" ~ "TP1",
    Date == "2021-04-01" ~ "TP2",
    Date == "2021-04-10" ~ "TP2",
    Date == "2021-04-29" ~ "TP3",
    Date == "2021-04-30" ~ "TP3",
    Date == "2021-05-27" ~ "TP4",
    Date == "2021-06-02" ~ "TP4",
    Date == "2021-06-24" ~ "TP5",
    Date == "2021-06-25" ~ "TP5", 
    Date == "2021-07-22" ~ "TP6",
    Date == "2021-07-23" ~ "TP6",
    Date == "2021-08-19" ~ "TP7",
    Date == "2021-09-01" ~ "TP7")) 
  
all <- all %>% 
  mutate(Assay = case_when(
    Light_Value == "0" ~ "Rd",
    Light_Value == "320" ~ "P",
    Light_Value == "337" ~ "P",
    Light_Value == "340" ~ "P",
    Light_Value == "350" ~ "P",
    Light_Value == "355" ~ "P",
    Light_Value == "368" ~ "P",
    Light_Value == "392" ~ "P",
    Light_Value == "321" ~ "P",
    Light_Value == "361" ~ "P",
    Light_Value == "319" ~ "P", 
    Light_Value == "334" ~ "P",
    Light_Value == "366" ~ "P",
    Light_Value == "358" ~ "P",
    Light_Value == "342" ~ "P"))

# all <- all %>% 
#   mutate(Assay = case_when(
#     Treatment == "Ambient" ~ "Ambient",
#     Treatment == "Heat" ~ "Heat",
#     Treatment == "Field-TP2" ~ "Field",
#     Treatment == "Field-TP3" ~ "Field",
#     Treatment == "Field-TP4" ~ "Field"))

```  

```{r}
gd <- all %>% 
        group_by(Assay,Timepoint,Treatment) %>% 
        summarise(avg = mean(micromol.cm2.h),
                  sem  = sd(micromol.cm2.h)/sqrt(length((micromol.cm2.h))))

# Remove Acclimatization rows, if desired
#all <- all %>%
#  filter(!Treatment==c("Acclimatization"))

all.plot <- ggplot(all, aes(x = Timepoint, y = micromol.cm2.h, group=Treatment)) +
  geom_point(alpha = .4, aes(colour = Treatment), size = 2) +
  geom_point(data = gd, aes(x = Timepoint, y = avg, group=Treatment, colour = Treatment), size=4)+
  scale_color_manual(values=c("black", "blue", "green", "red"))+
  #geom_errorbar(data = gd, aes(ymin=avg-sem, ymax=avg+sem)) +
  geom_point(data = gd, aes(x = Timepoint, y = avg-sem, group=Treatment, colour = Treatment), size=2, shape=8)+
  geom_point(data = gd, aes(x = Timepoint, y = avg+sem, group=Treatment, colour = Treatment), size=2, shape=8)+
  geom_line(data = gd, aes(x = Timepoint, y = avg, group=Treatment, colour = Treatment)) +
  #ylim(-0.4,0.5) +
  facet_wrap(~Assay, ncol = 2)+
  theme_bw()+
  theme(legend.position = c(0.63, 0.8),
        legend.title = element_text(colour="black", size=6, face="bold"),
        legend.text = element_text(size=4))+
  guides(color = guide_legend(override.aes = list(size = 1)))
all.plot

plot <- grid.arrange(all.plot, clip="off")
ggsave("output/Physiology/PR/All_Timepoint.Treatment_PR.pdf", plot, width = 4, height = 3.5, units = c("in"))
```

Remove outliers (micromol.cm2.h > 20) and plot 
```{r}
sub <- all %>% 
  filter(micromol.cm2.h <= 10) %>%
  filter(micromol.cm2.h >= -5)

gd <- sub %>% 
        group_by(Assay,Timepoint,Treatment) %>% 
        summarise(avg = mean(micromol.cm2.h),
                  sem  = sd(micromol.cm2.h)/sqrt(length((micromol.cm2.h))))

# Remove Acclimatization rows, if desired
#all <- all %>%
#  filter(!Treatment==c("Acclimatization"))

sub.plot <- ggplot(sub, aes(x = Timepoint, y = micromol.cm2.h, group=Treatment)) +
  geom_point(alpha = .4, aes(colour = Treatment), size = 2) +
  geom_point(data = gd, aes(x = Timepoint, y = avg, group=Treatment, colour = Treatment), size=4)+
  scale_color_manual(values=c("black", "blue", "green", "red"))+
  #geom_errorbar(data = gd, aes(ymin=avg-sem, ymax=avg+sem)) +
  geom_point(data = gd, aes(x = Timepoint, y = avg-sem, group=Treatment, colour = Treatment), size=2, shape=8)+
  geom_point(data = gd, aes(x = Timepoint, y = avg+sem, group=Treatment, colour = Treatment), size=2, shape=8)+
  geom_line(data = gd, aes(x = Timepoint, y = avg, group=Treatment, colour = Treatment)) +
  #ylim(-0.4,0.5) +
  facet_wrap(~Assay, ncol = 2)+
  theme_bw()+
  theme(legend.position = c(0.63, 0.8),
        legend.title = element_text(colour="black", size=6, face="bold"),
        legend.text = element_text(size=4))+
  guides(color = guide_legend(override.aes = list(size = 1)))
sub.plot

plot <- grid.arrange(sub.plot, clip="off")
ggsave("output/Physiology/PR/Sub_Timepoint.Treatment_PR.pdf", plot, width = 4, height = 3.5, units = c("in"))
```

## Plot w/ similar format to other phys plots (for Benthics Ecology Meeting 2023)
```{r}
## using the sub data and no field data included
sub <- all %>% 
  filter(micromol.cm2.h <= 10) %>%
  filter(micromol.cm2.h >= -5) %>%
  filter(Treatment == c("Ambient", "Heat"))

# Plot and save 
pr_plot <- ggplot(sub, aes(x = Timepoint, y = micromol.cm2.h, fill = Treatment)) +
  geom_boxplot(lwd = 1, color = "black") +
  scale_fill_manual(values = c("blue", "red")) +
  #ylab("Carbohydrates (mg/cm²)") +
  xlab("") +
  #hjust(x = 0) +
  facet_wrap(~Assay, ncol = 2) +
  theme_bw() +
  theme(legend.title = element_text(size = 28),
          legend.text = element_text(size = 25),
          legend.position = "right",
          legend.key.size = unit(3, "line")) +
  theme(axis.text.x = element_text(size = 30,
                                   color = "black")) +
   theme(axis.text.y = element_text(size = 30,
                                   color = "black"),
        axis.title.y = element_text(size = 35,
                                    margin = margin(t = 0, r = 20, b = 0, l = 0))) 
pr_plot
ggsave("output/Physiology/PR/PR_Treatment_20230423.pdf", pr_plot, width = 50, height = 25, units = "cm")
ggsave("output/Physiology/PR/PR_Treatment_20230423.png", pr_plot, width = 50, height = 25, units = "cm")
```

In the P and Rd plots, there is positive values present in Rd. This should not be happening because the respiration was measured in the dark so no oxygen production should be occurring in the absence of light. I'm not sure how to reconcile this...

I'm going to plot TP5, TP6 and TP7 without the earlier timepoints. I chose these specifically because TP5, TP6, and TP7 Rd values are all negative. Lets see how that plot looks
```{r}
# Subset by TP5, TP6 and TP7
sub_lateTPs <- sub %>% 
  filter(Timepoint == c("TP5", "TP6", "TP7"))

# Plot and save 
pr_plot <- ggplot(sub_lateTPs, aes(x = Timepoint, y = micromol.cm2.h, fill = Treatment)) +
  geom_boxplot(lwd = 1, color = "black") +
  scale_fill_manual(values = c("blue", "red")) +
  #ylab("Carbohydrates (mg/cm²)") +
  xlab("") +
  #hjust(x = 0) +
  facet_wrap(~Assay, ncol = 2) +
  theme_bw() +
  theme(legend.title = element_text(size = 28),
          legend.text = element_text(size = 25),
          legend.position = "right",
          legend.key.size = unit(3, "line")) +
  theme(axis.text.x = element_text(size = 30,
                                   color = "black")) +
   theme(axis.text.y = element_text(size = 30,
                                   color = "black"),
        axis.title.y = element_text(size = 35,
                                    margin = margin(t = 0, r = 20, b = 0, l = 0))) 
pr_plot
ggsave("output/Physiology/PR/PR_Treatment_TP5-7_20230423.pdf", pr_plot, width = 50, height = 25, units = "cm")
ggsave("output/Physiology/PR/PR_Treatment_TP5-7_20230423.png", pr_plot, width = 50, height = 25, units = "cm")
```







## Test for differences 
For now (as of 20230420), I'm using code based on this [tutorial](http://www.sthda.com/english/wiki/two-way-anova-test-in-r). I need to do some more investigations on stats stuff 
```{r}
# Separate into P and Rd dfs 
p_df <- sub %>%
  filter(Assay == "P")
rd_df <- sub %>%
  filter(Assay == "Rd")

################################# PHOTOSYNTHESIS ################################# 
## Compute two-way ANOVA test 
model <- aov(micromol.cm2.h ~ Treatment*Timepoint, data = p_df)
summary(model)

#                     Df Sum Sq Mean Sq F value  Pr(>F)   
# Treatment            1  0.884  0.8840   2.178 0.15075   
# Timepoint            6 10.495  1.7491   4.310 0.00317 **
# Treatment:Timepoint  6  0.540  0.0901   0.222 0.96649   
# Residuals           29 11.769  0.4058                   
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 5 observations deleted due to missingness

## Compute summary stats 
model.tables(model, type = "means", se = T)

## Multiple pairwise-comparisons between the means of groups 
# Tukey HSD 
TukeyHSD(model, which = "Timepoint")
## TP6 differs from TP1 (only slightly), TP2, and TP3

# Multiple comparisons using multcomp package

# Pairwise test 
pairwise.t.test(p_df$micromol.cm2.h, p_df$Timepoint, p.adjust.method = "bonf") # should I specify a p.adjust.method? 
## TP6 differs from TP1, TP2, and TP3



## Check ANOVA assumptions 
# ANOVA assumes data is normally distributed and variance across groups is homogenous 
# 1. Check homogeneity of variance assumption
# a. Residuals vs fits plot
plot(model, 1)

# b. Levene's test 
leveneTest(micromol.cm2.h ~ Timepoint*Treatment, data = sub)
## p-value is  less than 0.05, so variance is not homogenous 

# 2. Check normality assumption 
# a. Normality plot of residuals 
plot(model, 2) 
hist(residuals(model))

#b. Shapiro-Wilk test 
aov_residuals <- residuals(object = model)
shapiro.test(x = aov_residuals)
# pvalue is greater than 0.05 so normality is all good 







################################# RESPIRATION ################################# 
## Compute two-way ANOVA test 
model <- aov(log(micromol.cm2.h) ~ Treatment*Timepoint, data = rd_df)
summary(model)
```




